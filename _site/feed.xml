<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>renzhifan</title>
    <description></description>
    <link>http://localhost:4000/</link>
    <atom:link href="http://localhost:4000/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Wed, 25 Mar 2020 09:59:18 +0800</pubDate>
    <lastBuildDate>Wed, 25 Mar 2020 09:59:18 +0800</lastBuildDate>
    <generator>Jekyll v3.8.5</generator>
    
      <item>
        <title>网页调用微信Jssdk实现扫一扫功能</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#微信公众号配置&quot; id=&quot;markdown-toc-微信公众号配置&quot;&gt;微信公众号配置&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#第一步js接口安全域设置&quot; id=&quot;markdown-toc-第一步js接口安全域设置&quot;&gt;第一步，JS接口安全域设置&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#第二步配置ip白名单&quot; id=&quot;markdown-toc-第二步配置ip白名单&quot;&gt;第二步，配置ip白名单。&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#导入相关js&quot; id=&quot;markdown-toc-导入相关js&quot;&gt;导入相关JS&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#通过config接口注入权限验证配置&quot; id=&quot;markdown-toc-通过config接口注入权限验证配置&quot;&gt;通过config接口注入权限验证配置&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#调起扫一扫接口&quot; id=&quot;markdown-toc-调起扫一扫接口&quot;&gt;调起扫一扫接口&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#项目链接&quot; id=&quot;markdown-toc-项目链接&quot;&gt;项目链接&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;网页调用微信Jssdk实现扫一扫功能&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;微信公众号配置&quot;&gt;微信公众号配置&lt;/h2&gt;

&lt;h3 id=&quot;第一步js接口安全域设置&quot;&gt;第一步，JS接口安全域设置&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;/static/img/weixinsys/1.png&quot; alt=&quot;1.png&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;第二步配置ip白名单&quot;&gt;第二步，配置ip白名单。&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; 换服务器的时候被坑了。。。一直报config:invalid signature，之前都是弄好的。后面忘了
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/static/img/weixinsys/2.png&quot; alt=&quot;1.png&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;导入相关js&quot;&gt;导入相关JS&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;在需要调用JS接口的页面引入如下JS文件，（支持https）：
&lt;a href=&quot;http://res.wx.qq.com/open/js/jweixin-1.2.0.js&quot;&gt;http://res.wx.qq.com/open/js/jweixin-1.2.0.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;通过config接口注入权限验证配置&quot;&gt;通过config接口注入权限验证配置&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;var _data = {

  tokenUrl:location.href,

  t:Math.random()

};

var _getWechatSignUrl = HTTP_AUTH_HOST_SERVER+'czj/wx/XSign';

// 获取微信签名

$.ajax({

  url:_getWechatSignUrl,

  data:_data,

  dataType:&quot;jsonp&quot;,

  success:function (o) {

        //alert('获取数据：timestamp:'+o.value.timestamp+'nonceStr:'+o.value.nonceStr+'signature:'+o.value.signature);

     console.log(&quot;获取微信签名:&quot;+o);

  if (o.result ==true) {

    wxConfig(o.value.timestamp, o.value.nonceStr, o.value.signature,o.value.appId);

    console.log(&quot;appid:&quot;+o.value.appId)

}

},err:function (err) {

      alert(&quot;----&quot;+err);

}

});

function wxConfig(_timestamp, _nonceStr, _signature,_appId) {

     //alert('获取数据：'+_timestamp+'\n'+_nonceStr+'\n'+_signature);

    console.log('获取数据：' + _timestamp +'\n' + _nonceStr +'\n' + _signature);

  wx.config({

  debug:false,// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。

        appId: _appId,// 必填，公众号的唯一标识

        timestamp: _timestamp,// 必填，生成签名的时间戳

        nonceStr: _nonceStr,// 必填，生成签名的随机串

        signature: _signature,// 必填，签名，见附录1

        jsApiList: ['checkJsApi','scanQRCode']

// 必填，需要使用的JS接口列表，所有JS接口列表见附录2

    });

}     
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;调起扫一扫接口&quot;&gt;调起扫一扫接口&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;function scanCode(callback) {

  wx.scanQRCode({

  needResult:1,

  scanType: [&quot;qrCode&quot;,&quot;barCode&quot;],

  success:function (res) {

        console.log(res)

  //alert(JSON.stringify(res));

        var result = res.resultStr;

        setTimeout(callback(result),500);

   },

  error:function(res){

        alert(JSON.stringify(res))

        if(res.errMsg.indexOf('function_not_exist') &amp;gt;0){

        alert('版本过低请升级')

      }

    }

  });

}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;项目链接&quot;&gt;项目链接&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/renzhifan/origin&quot;&gt;项目链接&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Thu, 02 Jan 2020 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/tool/%E7%BD%91%E9%A1%B5%E8%B0%83%E7%94%A8%E5%BE%AE%E4%BF%A1Jssdk%E5%AE%9E%E7%8E%B0%E6%89%AB%E4%B8%80%E6%89%AB%E5%8A%9F%E8%83%BD/</link>
        <guid isPermaLink="true">http://localhost:4000/tool/%E7%BD%91%E9%A1%B5%E8%B0%83%E7%94%A8%E5%BE%AE%E4%BF%A1Jssdk%E5%AE%9E%E7%8E%B0%E6%89%AB%E4%B8%80%E6%89%AB%E5%8A%9F%E8%83%BD/</guid>
        
        <category>微信</category>
        
        <category>扫一扫</category>
        
        
        <category>Tool</category>
        
      </item>
    
      <item>
        <title>ubuntu 安装 elasticsearch和ik-analyzer中文分词</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#安装java环境&quot; id=&quot;markdown-toc-安装java环境&quot;&gt;安装java环境&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#安装elasticsearch&quot; id=&quot;markdown-toc-安装elasticsearch&quot;&gt;安装Elasticsearch&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#安装公钥&quot; id=&quot;markdown-toc-安装公钥&quot;&gt;安装公钥&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#添加源&quot; id=&quot;markdown-toc-添加源&quot;&gt;添加源&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#安装es&quot; id=&quot;markdown-toc-安装es&quot;&gt;安装es&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#命令管理&quot; id=&quot;markdown-toc-命令管理&quot;&gt;命令管理&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#systemd&quot; id=&quot;markdown-toc-systemd&quot;&gt;systemd&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#启动&quot; id=&quot;markdown-toc-启动&quot;&gt;启动&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#关闭&quot; id=&quot;markdown-toc-关闭&quot;&gt;关闭&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#端口与查看&quot; id=&quot;markdown-toc-端口与查看&quot;&gt;端口与查看&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#访问试下&quot; id=&quot;markdown-toc-访问试下&quot;&gt;访问试下&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#配置-elasticsearch&quot; id=&quot;markdown-toc-配置-elasticsearch&quot;&gt;配置 Elasticsearch&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#配置参数&quot; id=&quot;markdown-toc-配置参数&quot;&gt;配置参数&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#包的目录布局&quot; id=&quot;markdown-toc-包的目录布局&quot;&gt;包的目录布局&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#安装-ik-analyzer&quot; id=&quot;markdown-toc-安装-ik-analyzer&quot;&gt;安装 ik-analyzer&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#安装&quot; id=&quot;markdown-toc-安装&quot;&gt;安装&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#重启服务&quot; id=&quot;markdown-toc-重启服务&quot;&gt;重启服务&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#测试&quot; id=&quot;markdown-toc-测试&quot;&gt;测试&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#测试不使用分词&quot; id=&quot;markdown-toc-测试不使用分词&quot;&gt;测试不使用分词&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#测试使用分词&quot; id=&quot;markdown-toc-测试使用分词&quot;&gt;测试使用分词&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;收集的好文链接(长期更新)&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h1 id=&quot;安装java环境&quot;&gt;安装java环境&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;我们首先要配置java环境，这个需要Java8或者更新的包。一般执行以下命令时可以看看Java版本是否符合：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;default-jdk
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;安装elasticsearch&quot;&gt;安装Elasticsearch&lt;/h1&gt;

&lt;h2 id=&quot;安装公钥&quot;&gt;安装公钥&lt;/h2&gt;
&lt;p&gt;在安装之前我们需要下载和安装公钥，否则没有办法使用apt安装Elasticsearch。&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget &lt;span class=&quot;nt&quot;&gt;-qO&lt;/span&gt; - https://artifacts.elastic.co/GPG-KEY-elasticsearch | &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt-key add -
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;添加源&quot;&gt;添加源&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt-get &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;apt-transport-https
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;deb https://artifacts.elastic.co/packages/6.x/apt stable main&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sudo tee&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; /etc/apt/sources.list.d/elastic-6.x.list
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;安装es&quot;&gt;安装es&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt-get update &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt-get &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;elasticsearch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;这样就安装好了。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;命令管理&quot;&gt;命令管理&lt;/h2&gt;

&lt;h3 id=&quot;systemd&quot;&gt;systemd&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;设置开机启动：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl daemon-reload
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;elasticsearch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;启动&quot;&gt;启动&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl start elasticsearch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;关闭&quot;&gt;关闭&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl stop elasticsearch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;端口与查看&quot;&gt;端口与查看&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat &lt;span class=&quot;nt&quot;&gt;-plntu&lt;/span&gt;  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;访问试下&quot;&gt;访问试下&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-XGET&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'127.0.0.1:9200/?pretty'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;如果返回的数据如下所示，即表示安装成功了：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
  &quot;name&quot; : &quot;fi_nt2e&quot;,
  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,
  &quot;cluster_uuid&quot; : &quot;mO1Ly_8YSnWm1gYNPIL-MA&quot;,
  &quot;version&quot; : {
    &quot;number&quot; : &quot;6.8.6&quot;,
    &quot;build_flavor&quot; : &quot;default&quot;,
    &quot;build_type&quot; : &quot;deb&quot;,
    &quot;build_hash&quot; : &quot;3d9f765&quot;,
    &quot;build_date&quot; : &quot;2019-12-13T17:11:52.013738Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;7.7.2&quot;,
    &quot;minimum_wire_compatibility_version&quot; : &quot;5.6.0&quot;,
    &quot;minimum_index_compatibility_version&quot; : &quot;5.0.0&quot;
  },
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：Elasticsearch需要启动一会。如果启动完成立马执行上面的命令，可以会提示拒绝连接，多试几次就好了。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;配置-elasticsearch&quot;&gt;配置 Elasticsearch&lt;/h2&gt;

&lt;h3 id=&quot;配置参数&quot;&gt;配置参数&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;Elasticsearch 默认情况下从 /etc/elasticsearch/elasticsearch.yml 文件中加载它的配置。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;RPM也又一个系统配置文件（/etc/sysconfig/elasticsearch），它允许你设置以下参数：&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;参数&lt;/th&gt;
      &lt;th&gt;解释&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;JAVA_HOME&lt;/td&gt;
      &lt;td&gt;设置要使用的自定义Java路径&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;MAX_OPEN_FILES&lt;/td&gt;
      &lt;td&gt;打开文件的最大数量，默认65536&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;MAX_LOCKED_MEMORY&lt;/td&gt;
      &lt;td&gt;最大锁内存大小。如果你在elasticsearch.yml中使用bootstrap.memory_lock选项，请设置unlimited&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;MAX_MAP_COUNT&lt;/td&gt;
      &lt;td&gt;进程可能拥有的内存映射区域的最大值。如果使用 mmapfs 作为索引存储类型，请确认将其设置为较高的值。请检查linux内核文档关于max_map_count的更多信息。这是在elasticsearch启动之前通过sysctl设置的。默认是262144&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;ES_PATH_CONF&lt;/td&gt;
      &lt;td&gt;配置文件目录（需要包含elasticsearch.yml和log4j2.properties文件），默认路径是：/etc/elasticsearch&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;ES_JAVA_OPTS&lt;/td&gt;
      &lt;td&gt;Any additional JVM system properties you may want to apply.&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;RESTART_ON_UPGRADE&lt;/td&gt;
      &lt;td&gt;配置软件包升级时将会重新启动，默认是false。这意味着你在安装软件包之后手动重启elasticsearch实例。这样做的原因是为了保障, 在集群中更新时，在高流量网络和减少你集群的响应时间的情况下导致分片的重新分配。&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;包的目录布局&quot;&gt;包的目录布局&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;类型&lt;/th&gt;
      &lt;th&gt;描述&lt;/th&gt;
      &lt;th&gt;默认路径&lt;/th&gt;
      &lt;th&gt;设置&lt;/th&gt;
      &lt;th&gt; &lt;/th&gt;
      &lt;th&gt; &lt;/th&gt;
      &lt;th&gt; &lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;home&lt;/td&gt;
      &lt;td&gt;Elasticsearch家目录或者$ES_HOME&lt;/td&gt;
      &lt;td&gt;/usr/share/elasticsearch&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;bin&lt;/td&gt;
      &lt;td&gt;二进制脚本，包括elasticsearch去启动一个节点和elasticsearch-plugin安装插件&lt;/td&gt;
      &lt;td&gt;/etc/elasticsearch&lt;/td&gt;
      &lt;td&gt;conf&lt;/td&gt;
      &lt;td&gt;配置文件，包含elasticsearch.yml&lt;/td&gt;
      &lt;td&gt;/etc/elasticsearch&lt;/td&gt;
      &lt;td&gt;ES_PATH_CONF&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;conf&lt;/td&gt;
      &lt;td&gt;环境变量，包含 heap 大小，文件描述符。&lt;/td&gt;
      &lt;td&gt;/etc/default/elasticsearch&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;data&lt;/td&gt;
      &lt;td&gt;在节点上分配的每个索引/分片的数据文件的位置。可以容纳多个位置。&lt;/td&gt;
      &lt;td&gt;/var/lib/elasticsearch&lt;/td&gt;
      &lt;td&gt;path.data&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;logs&lt;/td&gt;
      &lt;td&gt;日志文件位置。&lt;/td&gt;
      &lt;td&gt;/var/log/elasticsearch&lt;/td&gt;
      &lt;td&gt;path.logs&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;plugins&lt;/td&gt;
      &lt;td&gt;插件文件位置. 每个插件将包含在一个子目录中.&lt;/td&gt;
      &lt;td&gt;/usr/share/elasticsearch/plugins&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;repo&lt;/td&gt;
      &lt;td&gt;共享文件系统存储库位置。可以容纳多个位置。文件系统存储库可以放置在指定目录中任何子目录中。&lt;/td&gt;
      &lt;td&gt;Not configured&lt;/td&gt;
      &lt;td&gt;path.repo&lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt; &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h1 id=&quot;安装-ik-analyzer&quot;&gt;安装 ik-analyzer&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意这里一定要选择和你的es版本匹配的ik版本&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;安装&quot;&gt;安装&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/usr/share/elasticsearch/bin/elasticsearch-plugin &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.8.6/elasticsearch-analysis-ik-6.8.6.zip
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;我的安装过程如下&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@JD:/etc/nginx/sites-available# /usr/share/elasticsearch/bin/elasticsearch-plugin &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.8.6/elasticsearch-analysis-ik-6.8.6.zip
warning: Falling back to java on path. This behavior is deprecated. Specify JAVA_HOME
-&amp;gt; Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.8.6/elasticsearch-analysis-ik-6.8.6.zip
&lt;span class=&quot;o&quot;&gt;[=================================================]&lt;/span&gt; 100%   
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@     WARNING: plugin requires additional permissions     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; java.net.SocketPermission &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; connect,resolve
See http://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html
&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;descriptions of what these permissions allow and the associated risks.

Continue with installation? &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;y/N]y
-&amp;gt; Installed analysis-ik
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;出现以上显示 表示安装成功&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;重启服务&quot;&gt;重启服务&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl restart elasticsearch  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;重启之后要等待一下&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;测试&quot;&gt;测试&lt;/h2&gt;

&lt;h3 id=&quot;测试不使用分词&quot;&gt;测试不使用分词&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@JD:/var/www/bbs# curl &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Content-Type: application/json'&lt;/span&gt;  &lt;span class=&quot;nt&quot;&gt;-XGET&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'localhost:9200/_analyze?pretty'&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{&quot;text&quot;:&quot;北京欢迎你&quot;}'&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;tokens&quot;&lt;/span&gt; : &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;token&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;北&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;start_offset&quot;&lt;/span&gt; : 0,
      &lt;span class=&quot;s2&quot;&gt;&quot;end_offset&quot;&lt;/span&gt; : 1,
      &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;IDEOGRAPHIC&amp;gt;&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;position&quot;&lt;/span&gt; : 0
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;token&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;京&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;start_offset&quot;&lt;/span&gt; : 1,
      &lt;span class=&quot;s2&quot;&gt;&quot;end_offset&quot;&lt;/span&gt; : 2,
      &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;IDEOGRAPHIC&amp;gt;&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;position&quot;&lt;/span&gt; : 1
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;token&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;欢&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;start_offset&quot;&lt;/span&gt; : 2,
      &lt;span class=&quot;s2&quot;&gt;&quot;end_offset&quot;&lt;/span&gt; : 3,
      &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;IDEOGRAPHIC&amp;gt;&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;position&quot;&lt;/span&gt; : 2
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;token&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;迎&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;start_offset&quot;&lt;/span&gt; : 3,
      &lt;span class=&quot;s2&quot;&gt;&quot;end_offset&quot;&lt;/span&gt; : 4,
      &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;IDEOGRAPHIC&amp;gt;&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;position&quot;&lt;/span&gt; : 3
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;token&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;你&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;start_offset&quot;&lt;/span&gt; : 4,
      &lt;span class=&quot;s2&quot;&gt;&quot;end_offset&quot;&lt;/span&gt; : 5,
      &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;IDEOGRAPHIC&amp;gt;&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;position&quot;&lt;/span&gt; : 4
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;测试使用分词&quot;&gt;测试使用分词&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@JD:/var/www/bbs# curl &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Content-Type: application/json'&lt;/span&gt;  &lt;span class=&quot;nt&quot;&gt;-XGET&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'localhost:9200/_analyze?pretty'&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{&quot;analyzer&quot;:&quot;ik_max_word&quot;,&quot;text&quot;:&quot;北京欢迎你&quot;}'&lt;/span&gt;  
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;tokens&quot;&lt;/span&gt; : &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;token&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;北京&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;start_offset&quot;&lt;/span&gt; : 0,
      &lt;span class=&quot;s2&quot;&gt;&quot;end_offset&quot;&lt;/span&gt; : 2,
      &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;CN_WORD&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;position&quot;&lt;/span&gt; : 0
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;token&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;欢迎&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;start_offset&quot;&lt;/span&gt; : 2,
      &lt;span class=&quot;s2&quot;&gt;&quot;end_offset&quot;&lt;/span&gt; : 4,
      &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;CN_WORD&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;position&quot;&lt;/span&gt; : 1
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;token&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;你&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;start_offset&quot;&lt;/span&gt; : 4,
      &lt;span class=&quot;s2&quot;&gt;&quot;end_offset&quot;&lt;/span&gt; : 5,
      &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;CN_CHAR&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;position&quot;&lt;/span&gt; : 2
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

</description>
        <pubDate>Fri, 27 Dec 2019 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/tool/ubuntu-%E5%AE%89%E8%A3%85-elasticsearch%E5%92%8Cik-analyzer%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/</link>
        <guid isPermaLink="true">http://localhost:4000/tool/ubuntu-%E5%AE%89%E8%A3%85-elasticsearch%E5%92%8Cik-analyzer%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/</guid>
        
        <category>ubuntu</category>
        
        <category>elasticsearch</category>
        
        <category>ik-analyzer</category>
        
        
        <category>Tool</category>
        
      </item>
    
      <item>
        <title>收集的好文链接(长期更新)</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#1支付类&quot; id=&quot;markdown-toc-1支付类&quot;&gt;1.支付类&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#1-1新微信服务号微信小程序微信支付支付宝支付-&quot; id=&quot;markdown-toc-1-1新微信服务号微信小程序微信支付支付宝支付-&quot;&gt;1-1.【新】微信服务号+微信小程序+微信支付+支付宝支付 &lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#2工具类&quot; id=&quot;markdown-toc-2工具类&quot;&gt;2.工具类&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#2-1postman的免费快速美观的替代方案postwoman&quot; id=&quot;markdown-toc-2-1postman的免费快速美观的替代方案postwoman&quot;&gt;2-1.Postman的免费，快速，美观的替代方案——Postwoman&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#2-2正版phpstorm免费激活步骤图文详解&quot; id=&quot;markdown-toc-2-2正版phpstorm免费激活步骤图文详解&quot;&gt;2-2.正版phpstorm免费激活步骤（图文详解&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#2-3swoft基于-swoole-原生协程的新时代-php-高性能协程全栈框架&quot; id=&quot;markdown-toc-2-3swoft基于-swoole-原生协程的新时代-php-高性能协程全栈框架&quot;&gt;2-3.Swoft(基于 Swoole 原生协程的新时代 PHP 高性能协程全栈框架)&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#2-4一个基于-mysql-协议swoole-开发的mysql数据库连接池&quot; id=&quot;markdown-toc-2-4一个基于-mysql-协议swoole-开发的mysql数据库连接池&quot;&gt;2-4.一个基于 MySQL 协议，Swoole 开发的MySQL数据库连接池。&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#3laravel相关&quot; id=&quot;markdown-toc-3laravel相关&quot;&gt;3.laravel相关&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#3-1laravel--swoole--adminlte-效率开发模板&quot; id=&quot;markdown-toc-3-1laravel--swoole--adminlte-效率开发模板&quot;&gt;3-1.laravel + swoole + adminlte 效率开发模板&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#4运维相关&quot; id=&quot;markdown-toc-4运维相关&quot;&gt;4.运维相关&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#4-1start-docker-lnmp&quot; id=&quot;markdown-toc-4-1start-docker-lnmp&quot;&gt;4-1.Start Docker LNMP&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#4-2docker-lnmp-docs&quot; id=&quot;markdown-toc-4-2docker-lnmp-docs&quot;&gt;4-2.Docker LNMP Docs&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#4-3laradock&quot; id=&quot;markdown-toc-4-3laradock&quot;&gt;4-3.laradock&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#4-4laradock_doc&quot; id=&quot;markdown-toc-4-4laradock_doc&quot;&gt;4-4.laradock_doc&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#4-5轻松部署-laravel-应用&quot; id=&quot;markdown-toc-4-5轻松部署-laravel-应用&quot;&gt;4-5.轻松部署 Laravel 应用&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#5-权限管理相关&quot; id=&quot;markdown-toc-5-权限管理相关&quot;&gt;5. 权限管理相关&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#5-1开始使用casbin&quot; id=&quot;markdown-toc-5-1开始使用casbin&quot;&gt;5-1.开始使用Casbin&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;收集的好文链接(长期更新)&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;1支付类&quot;&gt;1.支付类&lt;/h2&gt;

&lt;h3 id=&quot;1-1新微信服务号微信小程序微信支付支付宝支付-&quot;&gt;1-1.&lt;a href=&quot;https://github.com/zoujingli/WeChatDeveloper&quot;&gt;【新】微信服务号+微信小程序+微信支付+支付宝支付 &lt;/a&gt;&lt;/h3&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;2工具类&quot;&gt;2.工具类&lt;/h2&gt;

&lt;h3 id=&quot;2-1postman的免费快速美观的替代方案postwoman&quot;&gt;2-1.&lt;a href=&quot;https://postwoman.io/&quot;&gt;Postman的免费，快速，美观的替代方案——Postwoman&lt;/a&gt;&lt;/h3&gt;

&lt;h3 id=&quot;2-2正版phpstorm免费激活步骤图文详解&quot;&gt;2-2.&lt;a href=&quot;https://www.php.cn/tool/phpstorm/408348.html&quot;&gt;正版phpstorm免费激活步骤（图文详解&lt;/a&gt;&lt;/h3&gt;

&lt;h3 id=&quot;2-3swoft基于-swoole-原生协程的新时代-php-高性能协程全栈框架&quot;&gt;2-3.&lt;a href=&quot;https://www.swoft.org/&quot;&gt;Swoft(基于 Swoole 原生协程的新时代 PHP 高性能协程全栈框架)&lt;/a&gt;&lt;/h3&gt;

&lt;h3 id=&quot;2-4一个基于-mysql-协议swoole-开发的mysql数据库连接池&quot;&gt;2-4.&lt;a href=&quot;https://smproxy.louislivi.com/#/README&quot;&gt;一个基于 MySQL 协议，Swoole 开发的MySQL数据库连接池。&lt;/a&gt;&lt;/h3&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;3laravel相关&quot;&gt;3.laravel相关&lt;/h2&gt;

&lt;h3 id=&quot;3-1laravel--swoole--adminlte-效率开发模板&quot;&gt;3-1.&lt;a href=&quot;https://github.com/cranux/laravelDevelopmentTemplate&quot;&gt;laravel + swoole + adminlte 效率开发模板&lt;/a&gt;&lt;/h3&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;4运维相关&quot;&gt;4.运维相关&lt;/h2&gt;

&lt;h3 id=&quot;4-1start-docker-lnmp&quot;&gt;4-1.&lt;a href=&quot;https://github.com/khs1994-docker/lnmp/blob/master/README.cn.md&quot;&gt;Start Docker LNMP&lt;/a&gt;&lt;/h3&gt;

&lt;h3 id=&quot;4-2docker-lnmp-docs&quot;&gt;4-2.&lt;a href=&quot;https://docs.lnmp.khs1994.com/#%E5%BE%AE%E4%BF%A1%E8%AE%A2%E9%98%85%E5%8F%B7&quot;&gt;Docker LNMP Docs&lt;/a&gt;&lt;/h3&gt;

&lt;h3 id=&quot;4-3laradock&quot;&gt;4-3.&lt;a href=&quot;https://github.com/laradock/laradock&quot;&gt;laradock&lt;/a&gt;&lt;/h3&gt;

&lt;h3 id=&quot;4-4laradock_doc&quot;&gt;4-4.&lt;a href=&quot;https://laradock-docs.linganmin.cn/zh/getting-started/#%E8%A6%81%E6%B1%82&quot;&gt;laradock_doc&lt;/a&gt;&lt;/h3&gt;

&lt;h3 id=&quot;4-5轻松部署-laravel-应用&quot;&gt;4-5.&lt;a href=&quot;https://github.com/wi1dcard/laravel-deployment&quot;&gt;轻松部署 Laravel 应用&lt;/a&gt;&lt;/h3&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;5-权限管理相关&quot;&gt;5. 权限管理相关&lt;/h2&gt;

&lt;h3 id=&quot;5-1开始使用casbin&quot;&gt;5-1.&lt;a href=&quot;https://casbin.org/docs/zh-CN/get-started&quot;&gt;开始使用Casbin&lt;/a&gt;&lt;/h3&gt;

&lt;hr /&gt;

</description>
        <pubDate>Thu, 26 Dec 2019 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/tool/%E6%94%B6%E8%97%8F%E7%9A%84%E5%A5%BD%E6%96%87%E9%93%BE%E6%8E%A5(%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0)/</link>
        <guid isPermaLink="true">http://localhost:4000/tool/%E6%94%B6%E8%97%8F%E7%9A%84%E5%A5%BD%E6%96%87%E9%93%BE%E6%8E%A5(%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0)/</guid>
        
        <category>好文收藏</category>
        
        
        <category>Tool</category>
        
      </item>
    
      <item>
        <title>Ubuntu18.04 搭建 PHP 环境</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#1初始化系统&quot; id=&quot;markdown-toc-1初始化系统&quot;&gt;1.初始化系统&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#实验环境&quot; id=&quot;markdown-toc-实验环境&quot;&gt;实验环境&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#更新软件源&quot; id=&quot;markdown-toc-更新软件源&quot;&gt;更新软件源&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#本地化配置&quot; id=&quot;markdown-toc-本地化配置&quot;&gt;本地化配置&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#2安装-nginx&quot; id=&quot;markdown-toc-2安装-nginx&quot;&gt;2.安装 Nginx&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#通过apt安装-nginx&quot; id=&quot;markdown-toc-通过apt安装-nginx&quot;&gt;通过apt安装 Nginx&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#管理-nginx-服务&quot; id=&quot;markdown-toc-管理-nginx-服务&quot;&gt;管理 Nginx 服务&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#确认-nginx-正常运行&quot; id=&quot;markdown-toc-确认-nginx-正常运行&quot;&gt;确认 Nginx 正常运行&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#3安装-php-fpm&quot; id=&quot;markdown-toc-3安装-php-fpm&quot;&gt;3.安装 PHP-FPM&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#配置第三方软件源&quot; id=&quot;markdown-toc-配置第三方软件源&quot;&gt;配置第三方软件源&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#安装-php&quot; id=&quot;markdown-toc-安装-php&quot;&gt;安装 PHP&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#管理-php-fpm-服务&quot; id=&quot;markdown-toc-管理-php-fpm-服务&quot;&gt;管理 PHP-FPM 服务&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#确认-php-fpm-正常运行&quot; id=&quot;markdown-toc-确认-php-fpm-正常运行&quot;&gt;确认 PHP-FPM 正常运行&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#4composer&quot; id=&quot;markdown-toc-4composer&quot;&gt;4.Composer&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#安装-composer&quot; id=&quot;markdown-toc-安装-composer&quot;&gt;安装 Composer&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#第一种方式&quot; id=&quot;markdown-toc-第一种方式&quot;&gt;第一种方式&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#第二种方式&quot; id=&quot;markdown-toc-第二种方式&quot;&gt;第二种方式&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#第三种方式&quot; id=&quot;markdown-toc-第三种方式&quot;&gt;第三种方式&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#配置-packagist-中国镜像&quot; id=&quot;markdown-toc-配置-packagist-中国镜像&quot;&gt;配置 Packagist 中国镜像&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#5部署应用代码&quot; id=&quot;markdown-toc-5部署应用代码&quot;&gt;5.部署应用代码&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#创建一个新项目&quot; id=&quot;markdown-toc-创建一个新项目&quot;&gt;创建一个新项目&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#配置文件所有者&quot; id=&quot;markdown-toc-配置文件所有者&quot;&gt;配置文件所有者&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#6配置-nginx-站点&quot; id=&quot;markdown-toc-6配置-nginx-站点&quot;&gt;6.配置 Nginx 站点&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#nginx-站点配置&quot; id=&quot;markdown-toc-nginx-站点配置&quot;&gt;Nginx 站点配置&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#fastcgi-服务地址为-ip端口时的配置&quot; id=&quot;markdown-toc-fastcgi-服务地址为-ip端口时的配置&quot;&gt;FastCGI 服务地址为 IP:端口时的配置&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#首先修改php的配置文件&quot; id=&quot;markdown-toc-首先修改php的配置文件&quot;&gt;首先修改php的配置文件&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#配置一&quot; id=&quot;markdown-toc-配置一&quot;&gt;配置一&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#配置二&quot; id=&quot;markdown-toc-配置二&quot;&gt;配置二&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#注意&quot; id=&quot;markdown-toc-注意&quot;&gt;注意&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#重载-nginx&quot; id=&quot;markdown-toc-重载-nginx&quot;&gt;重载 Nginx&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#最终效果&quot; id=&quot;markdown-toc-最终效果&quot;&gt;最终效果&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#7安装mysql&quot; id=&quot;markdown-toc-7安装mysql&quot;&gt;7.安装MYSQL&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#通过apt安装mysql&quot; id=&quot;markdown-toc-通过apt安装mysql&quot;&gt;通过apt安装mysql&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#管理-mysql-服务&quot; id=&quot;markdown-toc-管理-mysql-服务&quot;&gt;管理 Mysql 服务&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#测试&quot; id=&quot;markdown-toc-测试&quot;&gt;测试&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#mysql-创建新用户&quot; id=&quot;markdown-toc-mysql-创建新用户&quot;&gt;mysql 创建新用户&lt;/a&gt;        &lt;ul&gt;
          &lt;li&gt;&lt;a href=&quot;#创建一个所有权用户&quot; id=&quot;markdown-toc-创建一个所有权用户&quot;&gt;创建一个所有权用户&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#创建一个条件限制用户&quot; id=&quot;markdown-toc-创建一个条件限制用户&quot;&gt;创建一个条件限制用户&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#注意-1&quot; id=&quot;markdown-toc-注意-1&quot;&gt;注意&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=&quot;#设置允许外网访问&quot; id=&quot;markdown-toc-设置允许外网访问&quot;&gt;设置允许外网访问&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#测试-1&quot; id=&quot;markdown-toc-测试-1&quot;&gt;测试&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#8生产环境的必要优化&quot; id=&quot;markdown-toc-8生产环境的必要优化&quot;&gt;8.生产环境的必要优化&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#nginx-配置&quot; id=&quot;markdown-toc-nginx-配置&quot;&gt;Nginx 配置&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#laravel-的配置缓存与路由缓存&quot; id=&quot;markdown-toc-laravel-的配置缓存与路由缓存&quot;&gt;Laravel 的配置缓存与路由缓存&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#composer&quot; id=&quot;markdown-toc-composer&quot;&gt;Composer&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#再谈文件权限&quot; id=&quot;markdown-toc-再谈文件权限&quot;&gt;再谈文件权限&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#杂项&quot; id=&quot;markdown-toc-杂项&quot;&gt;杂项&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;Ubuntu18.04 搭建 PHP 环境&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h1 id=&quot;1初始化系统&quot;&gt;1.初始化系统&lt;/h1&gt;

&lt;h2 id=&quot;实验环境&quot;&gt;实验环境&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;我们基于一台全新的 Ubuntu  18.04 LTS 服务器&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;更新软件源&quot;&gt;更新软件源&lt;/h2&gt;

&lt;p&gt;登录到服务器，我们首先要做的就是更新软件源：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt update
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：这里所说的「更新软件源」并非升级软件，在中文内更加准确的描述应当是 &lt;strong&gt;刷新软件源&lt;/strong&gt;。在这个过程中，包管理器（也就是 APT，可以理解为「软件管家」之类）将会从 &lt;strong&gt;软件源&lt;/strong&gt; 服务器上获取一份最新的包列表并建立本地缓存，包括软件名称、描述、最新版本、下载地址等等。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;你将会看到类似这样的输出：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@JD:~# apt update
Hit:1 http://mirrors.jdcloudcs.com/ubuntu bionic InRelease
Hit:2 http://mirrors.jdcloudcs.com/ubuntu bionic-updates InRelease
Hit:3 http://mirrors.jdcloudcs.com/ubuntu bionic-backports InRelease
Hit:4 http://mirrors.jdcloudcs.com/ubuntu bionic-security InRelease
Reading package lists... Done
Building dependency tree       
Reading state information... Done
112 packages can be upgraded. Run &lt;span class=&quot;s1&quot;&gt;'apt list --upgradable'&lt;/span&gt; to see them.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;最后一行有这样的提示：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;112 packages can be upgraded. Run 'apt list --upgradable' to see them.

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;意为有 112 个软件包可升级，执行 &lt;code class=&quot;highlighter-rouge&quot;&gt;apt list --upgradable&lt;/code&gt; 命令来查看它们。&lt;/p&gt;

&lt;p&gt;我们暂且忽略，直接升级：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ apt upgrade
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：生产环境下，更新任何软件包前都需要仔细检查，确保更新日志内没有影响现有环境的改动。另外，你也可以先不升级，对后续部署基本没有影响。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;你将会看到一大坨（是的，一坨）输出，它们是将被升级的软件列表；注意关注最后几行：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;112 upgraded, 5 newly installed, 0 to remove and 0 not upgraded.
Need to get 196 MB of archives.
After this operation, 348 MB of additional disk space will be used.
Do you want to continue? [Y/n] 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;意为此操作将占用 348 MB 磁盘空间。此时输入 &lt;code class=&quot;highlighter-rouge&quot;&gt;Y&lt;/code&gt;（注意关闭中文输入法），或直接回车即可开始升级。主流云服务厂商均有缓存软件源，数据流量是通过内网传输，所以该过程不会太慢。&lt;/p&gt;

&lt;h2 id=&quot;本地化配置&quot;&gt;本地化配置&lt;/h2&gt;

&lt;p&gt;所谓「本地化配置」，可理解为系统时区、单位、地址、语言等配置的统称。使其能够符合某一地区的习惯。虽然我们的母语是中文，但还是建议将服务器配置为英语，尽可能避免奇葩乱码等问题带来的影响。&lt;/p&gt;

&lt;p&gt;首先，执行以下命令生成美国本地化数据：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;locale-gen en_US.UTF-8
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;随后将本地化配置修改为 &lt;code class=&quot;highlighter-rouge&quot;&gt;en_US.UTF-8&lt;/code&gt; 即可：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;update-locale &lt;span class=&quot;nv&quot;&gt;LC_ALL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;en_US.UTF-8
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;如果服务器在国外，则服务商可能不会将其配置为东八区；我们还需手动修改时区为 &lt;code class=&quot;highlighter-rouge&quot;&gt;Asia/Shanghai&lt;/code&gt;：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;timedatectl set-timezone Asia/Shanghai
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;若你是在国内云服务商租用的服务器，那么极有可能时区已经配置好了。&lt;/p&gt;

&lt;p&gt;至此，系统初始化阶段完成。&lt;/p&gt;

&lt;h1 id=&quot;2安装-nginx&quot;&gt;2.安装 Nginx&lt;/h1&gt;

&lt;p&gt;上节我们刚刚完成一些基础的初始化工作；接下来，可以开始安装软件包了。在本课程内，我将使用大名鼎鼎的 Nginx 作为 Web 服务。&lt;/p&gt;

&lt;h2 id=&quot;通过apt安装-nginx&quot;&gt;通过apt安装 Nginx&lt;/h2&gt;

&lt;p&gt;由于我们执行 &lt;code class=&quot;highlighter-rouge&quot;&gt;apt update&lt;/code&gt; 更新软件源不久，所以直接安装 Nginx 即可：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;nginx
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;再次收到确认提示：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;0 upgraded, 18 newly installed, 0 to remove and 0 not upgraded.
Need to get 2,461 kB of archives.
After this operation, 8,210 kB of additional disk space will be used.
Do you want to continue? [Y/n] 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;上节为大家介绍过输入 &lt;code class=&quot;highlighter-rouge&quot;&gt;Y&lt;/code&gt; 或直接回车均可继续，也就是说此处的询问默认结果为 &lt;code class=&quot;highlighter-rouge&quot;&gt;Y&lt;/code&gt;。有个普遍共识是，在提供选项供用户选择时，以大写项为默认值。例如此处的 &lt;code class=&quot;highlighter-rouge&quot;&gt;[Y/n]&lt;/code&gt; 那么 &lt;code class=&quot;highlighter-rouge&quot;&gt;Y&lt;/code&gt; 即为默认值；同理，若是 &lt;code class=&quot;highlighter-rouge&quot;&gt;[a/b/c/D/e]&lt;/code&gt;，那么 &lt;code class=&quot;highlighter-rouge&quot;&gt;D&lt;/code&gt; 即为默认值。&lt;/p&gt;

&lt;p&gt;另外，上节介绍了更新软件源即为包管理器从软件源服务器拉取软件包列表并建立本地缓存。其实，当我们执行 &lt;code class=&quot;highlighter-rouge&quot;&gt;apt install&lt;/code&gt; 操作时，包管理器便会从本地缓存中找到该软件包的指定版本，并进行下载、安装。&lt;/p&gt;

&lt;p&gt;稍等几秒钟即可安装成功：&lt;/p&gt;

&lt;h2 id=&quot;管理-nginx-服务&quot;&gt;管理 Nginx 服务&lt;/h2&gt;

&lt;p&gt;我们可使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;service&lt;/code&gt; 命令管理服务状态，常用操作如下：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service nginx start &lt;span class=&quot;c&quot;&gt;# 启动 Nginx&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service nginx stop &lt;span class=&quot;c&quot;&gt;# 停止 Nginx&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service nginx restart &lt;span class=&quot;c&quot;&gt;# 重启 Nginx&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;同时，可使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl&lt;/code&gt; 命令开关服务的开机自启：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;nginx &lt;span class=&quot;c&quot;&gt;# 启用 Nginx 开机启动&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;systemctl disable nginx &lt;span class=&quot;c&quot;&gt;# 禁用 Nginx 开机启动&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：通常情况下，在 APT 安装后已默认启用 Nginx 开机启动。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;确认-nginx-正常运行&quot;&gt;确认 Nginx 正常运行&lt;/h2&gt;

&lt;p&gt;在浏览器内输入服务器公网 IP（或域名）并打开，出现默认欢迎页面说明 Nginx 已经正常运行：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/lnmp/lnmp_nginx.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;恭喜，Nginx 安装成功。&lt;/p&gt;

&lt;h1 id=&quot;3安装-php-fpm&quot;&gt;3.安装 PHP-FPM&lt;/h1&gt;

&lt;p&gt;安装 PHP 7.3。&lt;/p&gt;

&lt;h2 id=&quot;配置第三方软件源&quot;&gt;配置第三方软件源&lt;/h2&gt;

&lt;p&gt;由于 Ubuntu 的官方软件源通常不包含最新版本的 PHP，因此需要添加一个包含最新 PHP 的第三方软件源。&lt;/p&gt;

&lt;p&gt;在添加之前，我们首先安装名为 &lt;code class=&quot;highlighter-rouge&quot;&gt;software-properties-common&lt;/code&gt; 的软件包，它提供了快速管理软件源的实用脚本：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; software-properties-common
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;相比之前执行的 &lt;code class=&quot;highlighter-rouge&quot;&gt;apt install&lt;/code&gt; 命令，这次我添加了 &lt;code class=&quot;highlighter-rouge&quot;&gt;-y&lt;/code&gt; 选项，表示当 APT 遇到询问时默认确认，避免再次输入 &lt;code class=&quot;highlighter-rouge&quot;&gt;Y&lt;/code&gt; 并回车。&lt;/p&gt;

&lt;p&gt;随后，执行以下脚本添加第三方 PHP 软件源：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;add-apt-repository &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; ppa:ondrej/php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;成功后别忘记刷新：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt-get update
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;安装-php&quot;&gt;安装 PHP&lt;/h2&gt;

&lt;p&gt;PHP 的安装实际上分为三个软件包：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;PHP - PHP 自身。&lt;/li&gt;
  &lt;li&gt;PHP-CLI - PHP 的命令行接口，通俗地说，在命令行内执行 &lt;code class=&quot;highlighter-rouge&quot;&gt;php&lt;/code&gt; 便依赖于此包。&lt;/li&gt;
  &lt;li&gt;PHP-FPM - 全称为 &lt;code class=&quot;highlighter-rouge&quot;&gt;PHP FastCGI Process Manager&lt;/code&gt;，用于管理 PHP 进程，并提供 FastCGI 接口与 Nginx 交互；浏览网页时的请求便是由 Nginx 交由 PHP-FPM 处理的。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;apt install&lt;/code&gt; 支持多参数，所以我们不必执行多次安装，只需在单条命令内写明多个软件包即可：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; php7.3 php7.3-cli php7.3-fpm php7.3-dev
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;按照 &lt;a href=&quot;https://laravel.com/docs/6.x/installation#installation&quot;&gt;Laravel安装文档&lt;/a&gt; 的说明，接着安装几个必备的 PHP 扩展：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; php7.3-mbstring php7.3-xml php7.3-bcmath
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：由于 PDO 等扩展已经内置在 PHP 中，故无需额外安装。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;对于不同项目的不同依赖，可能有必要安装以下扩展，根据实际情况选择即可：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;php7.3-curl php7.3-gd php7.3-mysql php7.3-opcache php7.3-zip php7.3-sqlite3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;有个小技巧是，你可以通过 &lt;code class=&quot;highlighter-rouge&quot;&gt;apt-cache&lt;/code&gt; 命令来搜索当前软件源内的包：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;apt-cache search php7.3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;例如以上命令，将会得到所有名称、描述等信息内包含 &lt;code class=&quot;highlighter-rouge&quot;&gt;php7.3&lt;/code&gt; 字样的软件包：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;php-amqp - AMQP extension for PHP
php-apcu - APC User Cache for PHP
php-geoip - GeoIP module for PHP
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;管理-php-fpm-服务&quot;&gt;管理 PHP-FPM 服务&lt;/h2&gt;

&lt;p&gt;与管理 Nginx 服务类似，你同样可以通过 &lt;code class=&quot;highlighter-rouge&quot;&gt;service&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl&lt;/code&gt; 命令管理 PHP-FPM 服务：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service php7.3-fpm restart &lt;span class=&quot;c&quot;&gt;# 重启 PHP-FPM&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service php7.3-fpm start &lt;span class=&quot;c&quot;&gt;# 启动 PHP-FPM&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service php7.3-fpm stop &lt;span class=&quot;c&quot;&gt;# 停止 PHP-FPM&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;php7.3-fpm &lt;span class=&quot;c&quot;&gt;# 启用 PHP-FPM 开机启动&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;systemctl disable php7.3-fpm &lt;span class=&quot;c&quot;&gt;# 禁用 PHP-FPM 开机启动&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：不同版本的 PHP-FPM 服务名是不一致的。例如 7.2 为 &lt;code class=&quot;highlighter-rouge&quot;&gt;php7.2-fpm&lt;/code&gt;，7.3 为 &lt;code class=&quot;highlighter-rouge&quot;&gt;php7.3-fpm&lt;/code&gt;，以此类推……&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;确认-php-fpm-正常运行&quot;&gt;确认 PHP-FPM 正常运行&lt;/h2&gt;

&lt;p&gt;通过以下命令可确认 PHP-FPM 进程正在运行：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ps aux | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;其中：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ps aux&lt;/code&gt; 用于列出系统当前正在运行的所有进程的所有信息。&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;|&lt;/code&gt; 名为管道操作符，将前一条命令的标准输出连接到下一条命令的标准输入。&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;grep&lt;/code&gt; 是一款文本搜索工具，常用来过滤命令行输出；&lt;code class=&quot;highlighter-rouge&quot;&gt;php&lt;/code&gt; 是搜索的关键词。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ps&lt;/code&gt; 将进程信息输出到 &lt;code class=&quot;highlighter-rouge&quot;&gt;grep&lt;/code&gt; 进行过滤，后者筛选出包含 &lt;code class=&quot;highlighter-rouge&quot;&gt;php&lt;/code&gt; 字样的行，再将它们输出。于是，它们相结合，产生的效果便是这样：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-base&quot;&gt;root@JD:~# ps aux | grep php
root     24292  0.0  0.2 314952 20508 ?        Ss   11:35   0:00 php-fpm: master process (/etc/php/7.3/fpm/php-fpm.conf)
www-data 24318  0.0  0.1 317252  8652 ?        S    11:35   0:00 php-fpm: pool www
www-data 24319  0.0  0.1 317252  8652 ?        S    11:35   0:00 php-fpm: pool www
root     24391  0.0  0.0  13136  1048 pts/0    S+   11:36   0:00 grep --color=auto php
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;忽略最后一行（这是我们正在执行的 &lt;code class=&quot;highlighter-rouge&quot;&gt;grep&lt;/code&gt; 命令），可观察到有 &lt;code class=&quot;highlighter-rouge&quot;&gt;php-fpm&lt;/code&gt; 进程正在运行中。&lt;/p&gt;

&lt;p&gt;若 PHP-FPM 进程不存在，那么输出将只有孤零零的 &lt;code class=&quot;highlighter-rouge&quot;&gt;grep&lt;/code&gt;：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root     24391  0.0  0.0  13136  1048 pts/0    S+   11:36   0:00 grep --color=auto php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;提示：你可以结合上文提到的 &lt;code class=&quot;highlighter-rouge&quot;&gt;service&lt;/code&gt; 命令，将服务进程手动停止试试看；测试完毕不要忘记再次启动。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;4composer&quot;&gt;4.Composer&lt;/h1&gt;

&lt;p&gt;Composer 是部署 PHP 项目时必不可少的工具&lt;/p&gt;

&lt;h2 id=&quot;安装-composer&quot;&gt;安装 Composer&lt;/h2&gt;

&lt;p&gt;Composer 比较特殊，不能通过 APT 安装。虽然网络上流传着一大堆从第三方服务器直接下载 &lt;code class=&quot;highlighter-rouge&quot;&gt;composer.phar&lt;/code&gt; 文件的安装方式，但根据 Composer 的官方文档，正确的安装姿势应当为：&lt;/p&gt;

&lt;h3 id=&quot;第一种方式&quot;&gt;第一种方式&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://getcomposer.org/download/&quot;&gt;参考链接&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;php &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;copy('https://getcomposer.org/installer', 'composer-setup.php');&quot;&lt;/span&gt;
php &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;if (hash_file('sha384', 'composer-setup.php') === 'baf1608c33254d00611ac1705c1d9958c817a1a33bce370c0595974b342601bd80b92a3f46067da89e3b06bff421f182') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;&quot;&lt;/span&gt;
php composer-setup.php
php &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;unlink('composer-setup.php');&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;第二种方式&quot;&gt;第二种方式&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.phpcomposer.com/00-intro.html#Globally&quot;&gt;参考链接&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-sS&lt;/span&gt; https://getcomposer.org/installer | php
&lt;span class=&quot;nb&quot;&gt;mv &lt;/span&gt;composer.phar /usr/local/bin/composer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;第三种方式&quot;&gt;第三种方式&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://getcomposer.org/doc/faqs/how-to-install-composer-programmatically.md&quot;&gt;参考链接&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;wget https://raw.githubusercontent.com/composer/getcomposer.org/master/web/installer &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; - &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; | php &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--filename&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;composer &lt;span class=&quot;nt&quot;&gt;--install-dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/bin
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：通过第三方服务器、直接下载 &lt;code class=&quot;highlighter-rouge&quot;&gt;composer.phar&lt;/code&gt; 不进行任何检查，均无法保证 Composer 正常运行，且存在安全风险！请务必遵循官方文档内的说明。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;稍等片刻，将会出现以下输出：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;All settings correct for using Composer
Downloading...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;这里最好按照第二种方式  执行 mv composer.phar /usr/local/bin/composer
然后可以在任何地方执行composer了&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;提示当前环境检查通过，可正常使用 Composer；随后开始下载。&lt;/p&gt;

&lt;p&gt;鉴于众所周知的原因，大陆访问国际网络速度奇慢无比，请耐心等待。当出现以下提示时，表示已经安装成功：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Composer (version 1.9.1) successfully installed to: /root/composer.phar
Use it: php composer.phar
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;按照提示，我们可以使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;/usr/local/bin/composer&lt;/code&gt; 运行 Composer，当然，还有个更简单的方法：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mv &lt;/span&gt;composer.phar /usr/local/bin/composer
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;composer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;你可能会收到这样一条警告：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Do not run Composer as root/super user! See https://getcomposer.org/root &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;details
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;意为请勿使用根用户运行 Composer；暂时不必关心它，我将在后续课程中详细说明。&lt;/p&gt;

&lt;h2 id=&quot;配置-packagist-中国镜像&quot;&gt;配置 Packagist 中国镜像&lt;/h2&gt;

&lt;p&gt;这一步是可选的。如果你的服务器位于大陆，强烈建议使用可信赖的代理，或是国内 Packagist 镜像。&lt;/p&gt;

&lt;p&gt;推荐使用阿里云提供的 &lt;a href=&quot;https://developer.aliyun.com/composer&quot;&gt;Packagist 中国镜像&lt;/a&gt;，执行以下命令即可切换服务器内 Composer 的默认 Packagist 源：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;composer config &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; repo.packagist composer https://mirrors.aliyun.com/composer/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;5部署应用代码&quot;&gt;5.部署应用代码&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;这里以laravel项目为例&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;创建一个新项目&quot;&gt;创建一个新项目&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://laravel.com/docs/6.x/installation#installation&quot;&gt;laravel官网&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /var/www/
composer create-project &lt;span class=&quot;nt&quot;&gt;--prefer-dist&lt;/span&gt; laravel/laravel blog
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;若提示是没有zip扩展  那么请首先安装扩展&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;apt-get &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;php7.3-zip &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;配置文件所有者&quot;&gt;配置文件所有者&lt;/h2&gt;

&lt;p&gt;最后，别忘记修改文件所有者：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; www-data:www-data &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;由于目前所在的工作目录为 &lt;code class=&quot;highlighter-rouge&quot;&gt;/var/www/blog&lt;/code&gt;，所以可用表示当前工作目录的 &lt;code class=&quot;highlighter-rouge&quot;&gt;.&lt;/code&gt; 代替之前的 &lt;code class=&quot;highlighter-rouge&quot;&gt;/var/www/blog&lt;/code&gt;，它们是等效的。&lt;/p&gt;

&lt;p&gt;至此，本小节目标完成。你可以通过 &lt;code class=&quot;highlighter-rouge&quot;&gt;ll&lt;/code&gt; 命令来列出当前目录：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@JD:/var/www/blog# ll
total 300
drwxr-xr-x 12 www-data www-data   4096 Dec 26 12:03 ./
drwxr-xr-x  4 root     root       4096 Dec 26 12:02 ../
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;6配置-nginx-站点&quot;&gt;6.配置 Nginx 站点&lt;/h1&gt;

&lt;h2 id=&quot;nginx-站点配置&quot;&gt;Nginx 站点配置&lt;/h2&gt;

&lt;p&gt;根据 &lt;a href=&quot;https://laravel.com/docs/6.x/deployment&quot;&gt;Laravel部署文档&lt;/a&gt; 的说明，我们可直接拿到一份现成的 Nginx 配置文件，稍作调整即可：&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;我这里做了下解释说明 &lt;a href=&quot;https://wi1dcard.dev/posts/laravel-recommended-nginx-conf-analysis/&quot;&gt;参考文章&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-nginx highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#监听 HTTP 协议默认的 [80] 端口。
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;listen&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#绑定主机名 [example.com]。
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;server_name&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;example.com&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;#服务器站点根目录 [/example.com/public]。
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/example.com/public&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# 添加几条有关安全的响应头
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Frame-Options&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;SAMEORIGIN&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kn&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-XSS-Protection&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;mode=block&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kn&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Content-Type-Options&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;nosniff&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# 站点默认页面；可指定多个，将顺序查找。
&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;# 例如，访问 http://example.com/ Nginx 将首先尝试「站点根目录/index.html」是否存在，不存在则继续尝试「站点根目录/index.htm」，以此类推...
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;index.html&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;index.htm&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;index.php&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# 指定字符集为 UTF-8
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;charset&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;utf-8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# Laravel 默认重写规则；删除将导致 Laravel 路由失效且 Nginx 响应 404。
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kn&quot;&gt;try_files&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/index.php?&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$query_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
    &lt;span class=&quot;c1&quot;&gt;# 关闭 [/favicon.ico] 和 [/robots.txt] 的访问日志。
&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;# 并且即使它们不存在，也不写入错误日志。
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/favicon.ico&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;access_log&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;off&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;log_not_found&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;off&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;kn&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/robots.txt&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;access_log&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;off&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;log_not_found&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;off&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    
    &lt;span class=&quot;c1&quot;&gt;# 将 [404] 错误交给 [/index.php] 处理，表示由 Laravel 渲染美观的错误页面。
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;error_page&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;404&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/index.php&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# URI 符合正则表达式 [\.php$] 的请求将进入此段配置
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;\.php$&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# 配置 FastCGI 服务地址，可以为 IP:端口，也可以为 Unix socket。
&lt;/span&gt;        &lt;span class=&quot;kn&quot;&gt;fastcgi_pass&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;unix:/var/run/php/php7.2-fpm.sock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# 配置 FastCGI 的主页为 index.php。
&lt;/span&gt;        &lt;span class=&quot;kn&quot;&gt;fastcgi_index&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;index.php&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# 配置 FastCGI 参数 SCRIPT_FILENAME 为 $realpath_root$fastcgi_script_name。
&lt;/span&gt;        &lt;span class=&quot;kn&quot;&gt;fastcgi_param&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;SCRIPT_FILENAME&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$realpath_root$fastcgi_script_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# 引用更多默认的 FastCGI 参数。
&lt;/span&gt;        &lt;span class=&quot;kn&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;fastcgi_params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# 通俗地说，以上配置将所有 URI 以 .php 结尾的请求，全部交给 PHP-FPM 处理。
&lt;/span&gt;    
    &lt;span class=&quot;c1&quot;&gt;# 除符合正则表达式 [/\.(?!well-known).*] 之外的 URI，全部拒绝访问
&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;# 也就是说，拒绝公开以 [.] 开头的目录，[.well-known] 除外
&lt;/span&gt;    &lt;span class=&quot;kn&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;/\.(?!well-known).*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kn&quot;&gt;deny&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;all&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;通常我们仅需修改 &lt;code class=&quot;highlighter-rouge&quot;&gt;server_name&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;root&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;fastcgi_pass&lt;/code&gt;；请注意阅读 &lt;code class=&quot;highlighter-rouge&quot;&gt;#&lt;/code&gt; 后的注释。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /etc/nginx/sites-available

vi  blog.cn &lt;span class=&quot;c&quot;&gt;#填入你对应的配置信息&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#建立软连接&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo ln&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; /etc/nginx/sites-available/acme.cn /etc/nginx/sites-enabled/

&lt;span class=&quot;c&quot;&gt;#检测nginx配置是否正确&lt;/span&gt;
nginx &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#配置正常返回如下结果&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#nginx: the configuration file /etc/nginx/nginx.conf syntax is ok&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#nginx: configuration file /etc/nginx/nginx.conf test is successful&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#重启nginx&lt;/span&gt;
service nginx restart

&lt;span class=&quot;c&quot;&gt;#重启fpm 这里一定要重启&lt;/span&gt;
service php7.3-fpm restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;fastcgi-服务地址为-ip端口时的配置&quot;&gt;FastCGI 服务地址为 IP:端口时的配置&lt;/h2&gt;

&lt;h3 id=&quot;首先修改php的配置文件&quot;&gt;首先修改php的配置文件&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; vim /etc/php/7.3/fpm/pool.d/www.conf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;在37行加入如下代码&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; listen &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 127.0.0.1:9000
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;另外需要注意下如果配置文件内有 listen =/run/php/php7.3-fpm.sock 最好注释 以免冲突&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;配置一&quot;&gt;配置一&lt;/h3&gt;

&lt;p&gt;若fpm配置文件中配置如下：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; listen &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 127.0.0.1:9000
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;则对应的nginx.conf中的配置应为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; fastcgi_pass   127.0.0.1:9000&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;此时开启9000端口监听，不会生成sock文件&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;配置二&quot;&gt;配置二&lt;/h3&gt;

&lt;p&gt;若fpm中的配置为使用Unix套接字，如下：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; listen &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; /run/php/php7.3-fpm.sock
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;则对应nginx.conf中的配置应为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; fastcgi_pass   unix:/run/php/php7.3-fpm.sock&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;此时9000端口未开启，在/run/php/下生成php7.2-fpm.sock文件：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;注意&quot;&gt;注意&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;若两者不匹配则nginx启动失败。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;若fpm为sock，nginx为127.0.0.1:9000，则会出现以下错误：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;connect() failed (111: Connection refused) while connecting to upstream&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;若fpm未127.0.0.1:9000,nginx为sock，则会出现以下错误：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;connect() to unix:/run/php/php7.2-fpm.sock failed (2: No such file or directory) while connecting to upstream&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;重载-nginx&quot;&gt;重载 Nginx&lt;/h2&gt;

&lt;p&gt;配置完成后，请务必重启（Restart）或重载（Reload）Nginx。&lt;/p&gt;

&lt;p&gt;什么是 &lt;strong&gt;重载&lt;/strong&gt;？实际上，直接重启 Nginx 是不安全的。原因有二：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;在 Nginx 进程结束再重新运行的过程中，将造成极短时间的闪断。虽然这一时间通常很短（一般来说在秒级别），但倘若面对大量并发，还是极易造成一部分请求无法访问，即服务中断。&lt;/li&gt;
  &lt;li&gt;在重启的过程中，若此时 Nginx 恰好正在处理请求，与客户端的 TCP 连接将会断开，客户端无法收到正确响应，造成前后端信息不一致。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;在之前的小节中，已经提到重启 Nginx 的方法；&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service nginx restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;同样地，亦可使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;service&lt;/code&gt; 命令重载 Nginx：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service nginx reload
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;另一种等效的方法是：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nginx &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; reload
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;最终效果&quot;&gt;最终效果&lt;/h2&gt;

&lt;p&gt;在浏览器内输入服务器公网 IP 或域名并访问，你将会看到 Laravel 应用的默认主页：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/lnmp/laravel_hellow.png&quot; alt=&quot;页面效果&quot; /&gt;&lt;/p&gt;

&lt;p&gt;恭喜你，部署成功。&lt;/p&gt;

&lt;h1 id=&quot;7安装mysql&quot;&gt;7.安装MYSQL&lt;/h1&gt;

&lt;h2 id=&quot;通过apt安装mysql&quot;&gt;通过apt安装mysql&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;apt-get &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;mysql-server mysql-client &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;管理-mysql-服务&quot;&gt;管理 Mysql 服务&lt;/h2&gt;

&lt;p&gt;我们可使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;service&lt;/code&gt; 命令管理服务状态，常用操作如下：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service mysql start &lt;span class=&quot;c&quot;&gt;# 启动 Mysql&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service mysql stop &lt;span class=&quot;c&quot;&gt;# 停止 Mysql&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service mysql restart &lt;span class=&quot;c&quot;&gt;# 重启 Mysql&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;同时，可使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl&lt;/code&gt; 命令开关服务的开机自启：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;mysql &lt;span class=&quot;c&quot;&gt;# 启用 Mysql 开机启动&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;systemctl disable mysql &lt;span class=&quot;c&quot;&gt;# 禁用 Mysql 开机启动&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;通过以上配置，可使 Nginx 匹配请求 URI，若以 &lt;code class=&quot;highlighter-rouge&quot;&gt;js&lt;/code&gt; 或 &lt;code class=&quot;highlighter-rouge&quot;&gt;css&lt;/code&gt; 结尾，则将响应头 &lt;code class=&quot;highlighter-rouge&quot;&gt;Expires&lt;/code&gt; 的值设置为 &lt;code class=&quot;highlighter-rouge&quot;&gt;24h&lt;/code&gt; 返回。客户端浏览器将根据该值建立资源缓存，并在指定时间后过期，因此可节省部分服务器静态资源流量。&lt;code class=&quot;highlighter-rouge&quot;&gt;24h&lt;/code&gt; 可根据需要调整，若使用 CDN 服务分发静态资源，则不必配置此项。&lt;/p&gt;

&lt;h2 id=&quot;测试&quot;&gt;测试&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@JD:/var/run/php# mysql &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt;
Enter password: 
Welcome to the MySQL monitor.  Commands end with &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; or &lt;span class=&quot;se&quot;&gt;\g&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Your MySQL connection &lt;span class=&quot;nb&quot;&gt;id &lt;/span&gt;is 2
Server version: 5.7.28-0ubuntu0.18.04.4 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

Copyright &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 2000, 2019, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type &lt;span class=&quot;s1&quot;&gt;'help;'&lt;/span&gt; or &lt;span class=&quot;s1&quot;&gt;'\h'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;help. Type &lt;span class=&quot;s1&quot;&gt;'\c'&lt;/span&gt; to clear the current input statement.

mysql&amp;gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;出现以上结果说明mysql安装成功&lt;/p&gt;

&lt;p&gt;进入数据库后输入命令 设置新的密码&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;use mysql&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
update mysql.user &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;authentication_string&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;PASSWORD&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'新密码'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, &lt;span class=&quot;nv&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'mysql_native_password'&lt;/span&gt; where &lt;span class=&quot;nv&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'root'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#执行成功显示如下&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Query OK, 1 row affected, 1 warning (0.00 sec)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Rows matched: 1  Changed: 1  Warnings: 1&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#刷新权限&lt;/span&gt;
flush privileges&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Query OK, 0 rows affected (0.00 sec)&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;重启MySQL服务，再次进入数据库吗，输入新设置的密码 重启mysql服务&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;service mysql restart

mysql &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;mysql-创建新用户&quot;&gt;mysql 创建新用户&lt;/h2&gt;

&lt;h3 id=&quot;创建一个所有权用户&quot;&gt;创建一个所有权用户&lt;/h3&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mysql &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt;
mysql&amp;gt;create user db_user@&lt;span class=&quot;s1&quot;&gt;'%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'db_password'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#创建用户&lt;/span&gt;
mysql&amp;gt; grant all privileges on &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to db_user@&lt;span class=&quot;s1&quot;&gt;'%'&lt;/span&gt; with grant option&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#授权&lt;/span&gt;
flush privileges&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
mysql&amp;gt; &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;创建一个条件限制用户&quot;&gt;创建一个条件限制用户&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;添加一个用户名为db_user，密码为db_pass，授权为% （%表示所有IP能连接）对db_name数据库所有权限，命令如下：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#MySQL8.0版本&lt;/span&gt;
mysql &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt;
mysql&amp;gt;create user db_user@&lt;span class=&quot;s1&quot;&gt;'%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'db_pass'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#创建用户&lt;/span&gt;
mysql&amp;gt; grant all privileges on db_name.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to db_user@&lt;span class=&quot;s1&quot;&gt;'%'&lt;/span&gt; with grant option&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#授权&lt;/span&gt;
flush privileges&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
mysql&amp;gt; &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#其余MySQL版本&lt;/span&gt;
mysql&amp;gt; grant all privileges on db_name.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to db_user@&lt;span class=&quot;s1&quot;&gt;'%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'db_pass'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#授权语句，特别注意有分号&lt;/span&gt;
flush privileges&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
mysql&amp;gt; &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;注意-1&quot;&gt;注意&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;最后记得重启  service mysql restart 还有 如果是云服务器 记得设置安全组允许端口访问&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;设置允许外网访问&quot;&gt;设置允许外网访问&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vi /etc/mysql/mysql.conf.d/mysqld.cnf
&lt;span class=&quot;c&quot;&gt;#注释掉 #bind-address = 127.0.0.1&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;#再重启启动mysql 生效&lt;/span&gt;
service mysql restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;测试-1&quot;&gt;测试&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/static/img/lnmp/test_mysql.png&quot; alt=&quot;效果如图&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;8生产环境的必要优化&quot;&gt;8.生产环境的必要优化&lt;/h1&gt;

&lt;p&gt;本篇内容部分摘选自 &lt;a href=&quot;https://laravel.com/docs/6.x/deployment&quot;&gt;Laravel部署文档&lt;/a&gt;，你可以阅读该文档获取更多信息。&lt;/p&gt;

&lt;h2 id=&quot;nginx-配置&quot;&gt;Nginx 配置&lt;/h2&gt;

&lt;p&gt;对于 Laravel 应用来说，优化 Nginx 配置所带来的性能提升可谓微不足道。因此不建议在中小型项目中花费较多精力调优 Nginx。&lt;/p&gt;

&lt;p&gt;不过，有一点值得注意：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;server {
    # ...
    location ~* \.(js|css)$ {
        expires 24h;
    }
    #...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;通过以上配置，可使 Nginx 匹配请求 URI，若以 &lt;code class=&quot;highlighter-rouge&quot;&gt;js&lt;/code&gt; 或 &lt;code class=&quot;highlighter-rouge&quot;&gt;css&lt;/code&gt; 结尾，则将响应头 &lt;code class=&quot;highlighter-rouge&quot;&gt;Expires&lt;/code&gt; 的值设置为 &lt;code class=&quot;highlighter-rouge&quot;&gt;24h&lt;/code&gt; 返回。客户端浏览器将根据该值建立资源缓存，并在指定时间后过期，因此可节省部分服务器静态资源流量。&lt;code class=&quot;highlighter-rouge&quot;&gt;24h&lt;/code&gt; 可根据需要调整，若使用 CDN 服务分发静态资源，则不必配置此项。&lt;/p&gt;

&lt;h2 id=&quot;laravel-的配置缓存与路由缓存&quot;&gt;Laravel 的配置缓存与路由缓存&lt;/h2&gt;

&lt;p&gt;开启 &lt;strong&gt;配置缓存&lt;/strong&gt; 和 &lt;strong&gt;路由缓存&lt;/strong&gt; 能够在一定程度上提升 Laravel 的性能。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;php artisan config:cache &lt;span class=&quot;c&quot;&gt;# 生成配置缓存&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：当开启配置缓存后，&lt;code class=&quot;highlighter-rouge&quot;&gt;env()&lt;/code&gt; 函数将会失效；它将会永远返回 &lt;code class=&quot;highlighter-rouge&quot;&gt;null&lt;/code&gt;；因此务必确保在非配置文件内，未直接调用该函数。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;php artisan route:cache &lt;span class=&quot;c&quot;&gt;# 生成路由缓存&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：路由缓存仅支持控制器风格；若路由注册时存在闭包（Closures），则无法使用该功能。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：生成缓存后，对配置和路由的修改将不会生效，需再次执行缓存命令，或使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;php artisan cache:clear&lt;/code&gt; 命令清除它们。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;composer&quot;&gt;Composer&lt;/h2&gt;

&lt;p&gt;在安装依赖时，建议使用以下命令：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;composer &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--optimize-autoloader&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--no-dev&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;其中，&lt;code class=&quot;highlighter-rouge&quot;&gt;--optimize-autoloader&lt;/code&gt; 表示生成优化后的自动加载器，虽然生成过程可能较慢，但换来的是提高运行时的效率。&lt;code class=&quot;highlighter-rouge&quot;&gt;--no-dev&lt;/code&gt; 表示不安装 composer.json 中 &lt;code class=&quot;highlighter-rouge&quot;&gt;require-dev&lt;/code&gt; 声明的扩展包，在生产环境中我们不需要这些开发依赖。&lt;/p&gt;

&lt;h2 id=&quot;再谈文件权限&quot;&gt;再谈文件权限&lt;/h2&gt;

&lt;p&gt;文件权限直接关系到服务器安全与否。通常情况下，我们应当遵循「最小权限原则」，即权限越小越好。对于 Laravel 来说，我个人比较倾向的权限配置为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /var/www/blog
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;chmod&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; 750 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;chmod&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; 770 storage bootstrap/cache
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;你可以通过在线工具 &lt;a href=&quot;https://chmod-calculator.com/&quot;&gt;Chmod Calculator&lt;/a&gt; 来计算八进制权限数字：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/lnmp/per.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;上图是 &lt;code class=&quot;highlighter-rouge&quot;&gt;750&lt;/code&gt; 所代表的权限，即文件所有者可 &lt;strong&gt;读、写、执行（进入）&lt;/strong&gt;，文件所有组可 &lt;strong&gt;读、执行（进入）&lt;/strong&gt;，其余用户 &lt;strong&gt;均不可&lt;/strong&gt;。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意：对于文件来说，&lt;code class=&quot;highlighter-rouge&quot;&gt;Execute&lt;/code&gt; 权限表示可执行；对于目录来说，表示可进入（即 &lt;code class=&quot;highlighter-rouge&quot;&gt;cd&lt;/code&gt;）。为方便描述，以下统称为「执行」权限。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;也就是说，运行 Nginx 和 PHP-FPM 的 &lt;code class=&quot;highlighter-rouge&quot;&gt;www-data&lt;/code&gt; 用户，可读、写、执行；&lt;code class=&quot;highlighter-rouge&quot;&gt;www-data&lt;/code&gt; 用户组内的用户可读、执行。&lt;/p&gt;

&lt;p&gt;而 &lt;code class=&quot;highlighter-rouge&quot;&gt;770&lt;/code&gt; 则更加宽松 —— 对于 Laravel 运行时需要写入的目录，赋予文件所有组可 &lt;strong&gt;读、写、执行&lt;/strong&gt; 权限；也就是说 &lt;code class=&quot;highlighter-rouge&quot;&gt;www-data&lt;/code&gt; 用户组内的用户可写 &lt;code class=&quot;highlighter-rouge&quot;&gt;storage&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;bootstrap/cache&lt;/code&gt; 目录。&lt;/p&gt;

&lt;h2 id=&quot;杂项&quot;&gt;杂项&lt;/h2&gt;

&lt;p&gt;根据应用本身的逻辑不同，涉及的 Laravel 功能也不一样。针对部分项目，你有可能还需要执行以下 Artisan 命令：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;php artisan storage:link &lt;span class=&quot;c&quot;&gt;# 软链接 app/storage 到 public 目录，以便公开访问&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;php artisan migrate &lt;span class=&quot;c&quot;&gt;# 执行迁移&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;php artisan db:seed &lt;span class=&quot;c&quot;&gt;# 执行数据填充&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
</description>
        <pubDate>Thu, 26 Dec 2019 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/lnmp/Ubuntu18.04-%E6%90%AD%E5%BB%BA-PHP-%E7%8E%AF%E5%A2%83/</link>
        <guid isPermaLink="true">http://localhost:4000/lnmp/Ubuntu18.04-%E6%90%AD%E5%BB%BA-PHP-%E7%8E%AF%E5%A2%83/</guid>
        
        <category>ubuntu</category>
        
        <category>php</category>
        
        <category>lnmp</category>
        
        <category>composer</category>
        
        <category>nginx</category>
        
        <category>mysql</category>
        
        
        <category>lnmp</category>
        
      </item>
    
      <item>
        <title>以动画的方式，快速直观地查看 Git 文件变动历史</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#1说明&quot; id=&quot;markdown-toc-1说明&quot;&gt;1.说明&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#2效果如下&quot; id=&quot;markdown-toc-2效果如下&quot;&gt;2.效果如下：&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#3亲自体验&quot; id=&quot;markdown-toc-3亲自体验&quot;&gt;3.亲自体验&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#4其他方式&quot; id=&quot;markdown-toc-4其他方式&quot;&gt;4.其他方式&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#5参考文章&quot; id=&quot;markdown-toc-5参考文章&quot;&gt;5.参考文章&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;以动画的方式，快速直观地查看 Git 文件变动历史&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;1说明&quot;&gt;1.说明&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/pomber/git-history&quot;&gt;pomber/git-history&lt;/a&gt;是一款能够以动画形式快速、直观地展现 Git 仓库内文件变动历史的 Web 工具。&lt;/p&gt;

&lt;h2 id=&quot;2效果如下&quot;&gt;2.效果如下：&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/git.gif&quot; alt=&quot;动图效果&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;3亲自体验&quot;&gt;3.亲自体验&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://github.githistory.xyz/babel/babel/blob/master/packages/babel-core/test/browserify.js&quot;&gt;试试看&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;4其他方式&quot;&gt;4.其他方式&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;相比于主流的 Blame / Annotation，这种方式可以更加 迅速直观 地查看历史提交对于文件的变动影响。
该作者除了将仓库开源外，还将项目托管在了 https://githistory.xyz/。我们可以打开 GitHub 上的任意文件，然后将域名 github.com 替换为 github.githistory.xyz 即可使用。
似乎还是有些麻烦，域名比较长，若是短一些就更棒了；而且直接在地址栏修改域名通常没有补全，比较痛苦。
该项目给出另一个方案：&lt;a href=&quot;https://chrome.google.com/webstore/detail/git-history-browser-exten/laghnmifffncfonaoffcndocllegejnf&quot;&gt;Chrome Extension&lt;/a&gt; 在此，效果如下：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/git_2.png&quot; alt=&quot;效果&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;5参考文章&quot;&gt;5.参考文章&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://learnku.com/articles/23986&quot;&gt;参考文章&lt;/a&gt;&lt;/p&gt;

</description>
        <pubDate>Wed, 25 Dec 2019 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/git/%E4%BB%A5%E5%8A%A8%E7%94%BB%E7%9A%84%E6%96%B9%E5%BC%8F-%E5%BF%AB%E9%80%9F%E7%9B%B4%E8%A7%82%E5%9C%B0%E6%9F%A5%E7%9C%8B-Git-%E6%96%87%E4%BB%B6%E5%8F%98%E5%8A%A8%E5%8E%86%E5%8F%B2/</link>
        <guid isPermaLink="true">http://localhost:4000/git/%E4%BB%A5%E5%8A%A8%E7%94%BB%E7%9A%84%E6%96%B9%E5%BC%8F-%E5%BF%AB%E9%80%9F%E7%9B%B4%E8%A7%82%E5%9C%B0%E6%9F%A5%E7%9C%8B-Git-%E6%96%87%E4%BB%B6%E5%8F%98%E5%8A%A8%E5%8E%86%E5%8F%B2/</guid>
        
        <category>git</category>
        
        
        <category>git</category>
        
      </item>
    
      <item>
        <title>基于 MySQL 协议，Swoole 开发的MySQL数据库连接池使用教程。</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#安装&quot; id=&quot;markdown-toc-安装&quot;&gt;安装&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#运行&quot; id=&quot;markdown-toc-运行&quot;&gt;运行&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#我遇到的问题&quot; id=&quot;markdown-toc-我遇到的问题&quot;&gt;我遇到的问题&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#我的databasejson文件如下&quot; id=&quot;markdown-toc-我的databasejson文件如下&quot;&gt;我的database.json文件如下&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#我的serverjson文件如下&quot; id=&quot;markdown-toc-我的serverjson文件如下&quot;&gt;我的server.json文件如下&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#官网说明&quot; id=&quot;markdown-toc-官网说明&quot;&gt;官网说明&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;基于 MySQL 协议，Swoole 开发的MySQL数据库连接池使用教程&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;安装&quot;&gt;安装&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/louislivi/SMProxy.git
composer install --no-dev # 如果你想贡献你的代码，请不要使用 --no-dev 参数。
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;运行&quot;&gt;运行&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd SMProxy
bin/SMProxy start 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;启动成功后的界面如下所示&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@JD:/var/www/SMProxy# bin/SMProxy start

  /$$$$$$  /$$      /$$ /$$$$$$$                                        
 /$$__  $$| $$$    /$$$| $$__  $$                                       
| $$  \__/| $$$$  /$$$$| $$  \ $$ /$$$$$$   /$$$$$$  /$$   /$$ /$$   /$$
|  $$$$$$ | $$ $$/$$ $$| $$$$$$$//$$__  $$ /$$__  $$|  $$ /$$/| $$  | $$
 \____  $$| $$  $$$| $$| $$____/| $$  \__/| $$  \ $$ \  $$$$/ | $$  | $$
 /$$  \ $$| $$\  $ | $$| $$     | $$      | $$  | $$  &amp;gt;$$  $$ | $$  | $$
|  $$$$$$/| $$ \/  | $$| $$     | $$      |  $$$$$$/ /$$/\  $$|  $$$$$$$
 \______/ |__/     |__/|__/     |__/       \______/ |__/  \__/ \____  $$
                                                               /$$  | $$
                                                              |  $$$$$$/
                                                               \______/
                                                               

SMProxy version: v1.3.0@e6a640a

Server starting ...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;查看启动后的状态&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@JD:/var/www/SMProxy# bin/SMProxy status
SMProxy[v1.3.0] - Linux JD 4.4.0-62-generic #83-Ubuntu SMP Wed Jan 18 14:10:15 UTC 2017 x86_64
Host: 0.0.0.0, Port: 3366, PHPVerison: 7.3.12-1+ubuntu16.04.1+deb.sury.org+1
SwooleVersion: 4.4.12, WorkerNum: 2
Process :  26 total,  24 sleep,  2 query
+------+--------+-----------------+-----------+---------+------+-----------+-----------------------------+-------------------------+-----------------------+---------------+-------------+
| ID   | USER   | HOST            | DB        | COMMAND | TIME | STATE     | INFO                        | SERVER_VERSION          | PLUGIN_NAME           | SERVER_STATUS | SERVER_KEY  |
+------+--------+-----------------+-----------+---------+------+-----------+-----------------------------+-------------------------+-----------------------+---------------+-------------+
| 1789 | zhifan | localhost:58178 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | writeSΜbbs |
| 1790 | zhifan | localhost:58182 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | writeSΜbbs |
| 1791 | zhifan | localhost:58186 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | writeSΜbbs |
| 1793 | zhifan | localhost:58190 | bbs       | Query   | 0    | executing | /*SMProxy processlist sql*/ | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | writeSΜbbs |
| 1794 | zhifan | localhost:58196 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1795 | zhifan | localhost:58200 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1796 | zhifan | localhost:58204 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1797 | zhifan | localhost:58208 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1798 | zhifan | localhost:58212 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1799 | zhifan | localhost:58216 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1800 | zhifan | localhost:58220 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1801 | zhifan | localhost:58224 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1802 | zhifan | localhost:58228 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1803 | zhifan | localhost:58232 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1804 | zhifan | localhost:58236 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1805 | zhifan | localhost:58240 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1806 | zhifan | localhost:58244 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1807 | zhifan | localhost:58248 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1808 | zhifan | localhost:58252 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1809 | zhifan | localhost:58270 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1810 | zhifan | localhost:58268 | bbs       | Query   | 0    | executing | /*SMProxy processlist sql*/ | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1811 | zhifan | localhost:58264 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1812 | zhifan | localhost:58260 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1813 | zhifan | localhost:58256 | bbs       | Sleep   | 35   |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | readSΜbbs  |
| 1814 | zhifan | localhost:58278 | bookstack | Sleep   | 6    |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | read        |
| 1815 | zhifan | localhost:58280 | bookstack | Sleep   | 6    |           |                             | 5.7.28-0ubuntu0.16.04.2 | mysql_native_password | 2             | read        |
+------+--------+-----------------+-----------+---------+------+-----------+-----------------------------+-------------------------+-----------------------+---------------+-------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;h2 id=&quot;我遇到的问题&quot;&gt;我遇到的问题&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;2019-12-17 13:37:21 [warning] Config serverInfo-&amp;gt;write-&amp;gt;account is not exists! (/var/www/SMProxy/src/Base.php:99)
2019-12-17 13:37:21 [warning] Config serverInfo-&amp;gt;write-&amp;gt;account is not exists! (/var/www/SMProxy/src/Base.php:99)
2019-12-17 13:38:35 [info] Worker started!
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://smproxy.louislivi.com/#/README?id=%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98&quot;&gt;常见问题&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;参考上面的说明 我把database-&amp;gt;account下面的root 改为了zhifan 然后启动成功&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;这里附上我自己的配置文件 对于account对应的用户名非root远程访问的一定要记得修改root那个key为自己账户的&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;我的databasejson文件如下&quot;&gt;我的database.json文件如下&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
  &quot;database&quot;: {
    &quot;account&quot;: {
      &quot;db_user&quot;: { # 我就是错在这里了  之前是root  我忘记修改 导致报错 改完之后即可正常运行
        &quot;zhifan&quot;: &quot;zhifan&quot;, 
        &quot;password&quot;: &quot;password&quot;
      }
    },
    &quot;serverInfo&quot;: {
      &quot;server1&quot;: {
        &quot;write&quot;: {
          &quot;host&quot;: [&quot;127.0.0.1&quot;],
          &quot;port&quot;: 3306,
          &quot;timeout&quot;: 2,
          &quot;account&quot;: &quot;zhifan&quot;
        },
        &quot;read&quot;: {
          &quot;host&quot;: [&quot;127.0.0.1&quot;],
          &quot;port&quot;: 3306,
          &quot;timeout&quot;: 2,
          &quot;account&quot;: &quot;zhifan&quot;,
          &quot;startConns&quot;: &quot;swoole_cpu_num()*10&quot;,
          &quot;maxSpareConns&quot;: &quot;swoole_cpu_num()*10&quot;,
          &quot;maxSpareExp&quot;: 3600,
          &quot;maxConns&quot;: &quot;swoole_cpu_num()*20&quot;
        }
      }
    },
    &quot;databases&quot;: {
      &quot;bbs&quot;: {
        &quot;serverInfo&quot;: &quot;server1&quot;,
        &quot;startConns&quot;: &quot;swoole_cpu_num()*2&quot;,
        &quot;maxSpareConns&quot;: &quot;swoole_cpu_num()*2&quot;,
        &quot;maxSpareExp&quot;: 3600,
        &quot;maxConns&quot;: &quot;swoole_cpu_num()*2&quot;,
        &quot;charset&quot;: &quot;utf8mb4&quot;
      }
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;该命令会发布配置文件 laravels.php 到 config 目录下，以及脚本文件到 bin 目录下：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;我的serverjson文件如下&quot;&gt;我的server.json文件如下&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
  &quot;server&quot;: {
    &quot;user&quot;: &quot;root&quot;,
    &quot;password&quot;: &quot;123456&quot;,
    &quot;charset&quot;: &quot;utf8mb4&quot;,
    &quot;host&quot;: &quot;0.0.0.0&quot;,
    &quot;port&quot;: &quot;3366&quot;,
    &quot;mode&quot;: &quot;SWOOLE_PROCESS&quot;,
    &quot;sock_type&quot;: &quot;SWOOLE_SOCK_TCP&quot;,
    &quot;logs&quot;: {
      &quot;open&quot;:true,
      &quot;config&quot;: {
        &quot;system&quot;: {
          &quot;log_path&quot;: &quot;ROOT/logs&quot;,
          &quot;log_file&quot;: &quot;system.log&quot;,
          &quot;format&quot;: &quot;Y/m/d&quot;
        },
        &quot;mysql&quot;: {
          &quot;log_path&quot;: &quot;ROOT/logs&quot;,
          &quot;log_file&quot;: &quot;mysql.log&quot;,
          &quot;format&quot;: &quot;Y/m/d&quot;
        }
      }
    },
    &quot;swoole&quot;: {
      &quot;worker_num&quot;: &quot;swoole_cpu_num()&quot;,
      &quot;max_coro_num&quot;: 6000,
      &quot;open_tcp_nodelay&quot;: true,
      &quot;daemonize&quot;: true,
      &quot;heartbeat_check_interval&quot;: 60,
      &quot;heartbeat_idle_time&quot;: 600,
      &quot;reload_async&quot;: true,
      &quot;log_file&quot;: &quot;ROOT/logs/swoole.log&quot;,
      &quot;pid_file&quot;: &quot;ROOT/logs/pid/server.pid&quot;
    },
    &quot;swoole_client_setting&quot;: {
      &quot;package_max_length&quot;: 16777215
    },
    &quot;swoole_client_sock_setting&quot;: {
      &quot;sock_type&quot;: &quot;SWOOLE_SOCK_TCP&quot;
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;官网说明&quot;&gt;官网说明&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://smproxy.louislivi.com/#/README&quot;&gt;参考官网链接&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Tue, 17 Dec 2019 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/mysql/%E5%9F%BA%E4%BA%8E-SMProxy-%E9%80%9A%E8%BF%87%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%AE%9E%E7%8E%B0-MySQL-%E8%BF%9E%E6%8E%A5%E6%B1%A0/</link>
        <guid isPermaLink="true">http://localhost:4000/mysql/%E5%9F%BA%E4%BA%8E-SMProxy-%E9%80%9A%E8%BF%87%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%AE%9E%E7%8E%B0-MySQL-%E8%BF%9E%E6%8E%A5%E6%B1%A0/</guid>
        
        <category>SMProxy</category>
        
        <category>mysql</category>
        
        
        <category>mysql</category>
        
      </item>
    
      <item>
        <title>基于 Swoole 在 Laravel 中实现异步任务队列</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#1实现原理&quot; id=&quot;markdown-toc-1实现原理&quot;&gt;1.实现原理&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#2-编写任务类-appjobstesttaskphp&quot; id=&quot;markdown-toc-2-编写任务类-appjobstesttaskphp&quot;&gt;2. 编写任务类 App\Jobs\TestTask.php&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#3-编写测试代码&quot; id=&quot;markdown-toc-3-编写测试代码&quot;&gt;3. 编写测试代码&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#4修改配置文件&quot; id=&quot;markdown-toc-4修改配置文件&quot;&gt;4.修改配置文件&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#5测试异步任务执行&quot; id=&quot;markdown-toc-5测试异步任务执行&quot;&gt;5.测试异步任务执行&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;基于 Swoole 在 Laravel 中实现异步任务队列&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;1实现原理&quot;&gt;1.实现原理&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;PHP 本身的设计是同步阻塞的，不支持多线程和异步 IO，所以当我们执行一些耗时的操作，
比如发送广播，或者邮件，如果直接在当前进程中操作，会导致服务器响应变慢，
因此要借助一些第三方服务来处理以实现异步功能，
比如队列，而 Swoole 作为 PHP 异步网络通信引擎，
自然也对异步任务处理提供了支持，
其底层的实现原理和常见的异步队列类似：
将耗时任务投递到 TaskWorker 进程池后返回
（相应任务会通过 TaskWorker 异步执行，执行成功后可以调用事先注册的回调函数进行后续处理），
继续后续业务逻辑的执行，而不影响当前请求的处理速度。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;2-编写任务类-appjobstesttaskphp&quot;&gt;2. 编写任务类 App\Jobs\TestTask.php&lt;/h2&gt;
&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;App\Jobs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Hhxsv5\LaravelS\Swoole\Task\Task&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Support\Facades\Log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TestTask&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Task&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 待处理任务数据&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 任务处理结果&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;__construct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 任务投递调用 task 回调时触发，等同于 Swoole 中的 onTask 逻辑&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;Log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;__CLASS__&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;': 开始处理任务'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//  todo 耗时任务具体处理逻辑在这里编写&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 模拟任务需要3秒才能执行完毕&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'The result of '&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;' is balabalabala'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 任务完成调用 finish 回调时触发，等同于 Swoole 中的 onFinish 逻辑&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 可选的，完成事件，任务处理完后的逻辑，运行在Worker进程中，可以投递任务&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;finish&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;\Log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;__CLASS__&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;':finish start'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//        Task::deliver(new TestTask2('task2')); // 投递其他任务&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;h2 id=&quot;3-编写测试代码&quot;&gt;3. 编写测试代码&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;然后在 routes/web.php 编写投递异步任务的测试代码如下：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Hhxsv5\LaravelS\Swoole\Task\Task&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;App\Jobs\TestTask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;Route&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'/task/test'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$task&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;TestTask&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'task data'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// $task-&amp;gt;delay(3);// 延迟3秒投放任务&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$ret&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;deliver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$task&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;var_dump&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ret&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//判断是否投递成功&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;该命令会发布配置文件 laravels.php 到 config 目录下，以及脚本文件到 bin 目录下：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;4修改配置文件&quot;&gt;4.修改配置文件&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;在配置文件 config/laravels.php 中取消 task_worker_num 配置项前面的注释：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; &lt;span class=&quot;s1&quot;&gt;'swoole'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
     &lt;span class=&quot;s1&quot;&gt;'task_worker_num'&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;function_exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'swoole_cpu_num'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;swoole_cpu_num&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
 &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;5测试异步任务执行&quot;&gt;5.测试异步任务执行&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;接下来，我们重启启动 Swoole 服务器（基于 Swoole HTTP 服务器访问路由才能成功投递异步任务）：&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;php bin/laravels restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;然后在浏览器中通过 http://你的域名/task/test 访问测试路由，页面立即显示投递成功：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bool(true)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;然后我们去 storage/logs 目录下查看最新的日志信息，可以看到任务执行其实耗费了 3 秒：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/swoole_asynchronous.png&quot; alt=&quot;如图所示&quot; /&gt;&lt;/p&gt;
</description>
        <pubDate>Thu, 12 Dec 2019 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/swoole/%E5%9F%BA%E4%BA%8E-Swoole-%E5%9C%A8-Laravel-%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97/</link>
        <guid isPermaLink="true">http://localhost:4000/swoole/%E5%9F%BA%E4%BA%8E-Swoole-%E5%9C%A8-Laravel-%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97/</guid>
        
        <category>swoole</category>
        
        <category>laravel</category>
        
        
        <category>swoole</category>
        
      </item>
    
      <item>
        <title>在 Laravel 中集成 Swoole 实现 WebSocket 服务器</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#1创建-appserviceswebsocketservicephp文件&quot; id=&quot;markdown-toc-1创建-appserviceswebsocketservicephp文件&quot;&gt;1.创建 App/Services/WebSocketService.php文件&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#2-更改配置configlaravelsphp&quot; id=&quot;markdown-toc-2-更改配置configlaravelsphp&quot;&gt;2. 更改配置config/laravels.php&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#3-配置-nginx-支持-websocket&quot; id=&quot;markdown-toc-3-配置-nginx-支持-websocket&quot;&gt;3. 配置 Nginx 支持 WebSocket&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#4重载配置并重启laravels服务&quot; id=&quot;markdown-toc-4重载配置并重启laravels服务&quot;&gt;4.重载配置并重启Laravels服务&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#5配置wss服务&quot; id=&quot;markdown-toc-5配置wss服务&quot;&gt;5.配置wss服务&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#6配置测试页面&quot; id=&quot;markdown-toc-6配置测试页面&quot;&gt;6.配置测试页面&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#6-1-在webphp新增路由&quot; id=&quot;markdown-toc-6-1-在webphp新增路由&quot;&gt;6-1 在web.php新增路由&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#6-2-在resourcesviews新增wsbladephp&quot; id=&quot;markdown-toc-6-2-在resourcesviews新增wsbladephp&quot;&gt;6-2 在resources/views新增ws.blade.php&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#6-3-在页面测试如下&quot; id=&quot;markdown-toc-6-3-在页面测试如下&quot;&gt;6-3 在页面测试如下&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;在 Laravel 中集成 Swoole 实现 WebSocket 服务器&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;1创建-appserviceswebsocketservicephp文件&quot;&gt;1.创建 App/Services/WebSocketService.php文件&lt;/h2&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;App\Services&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Hhxsv5\LaravelS\Swoole\WebSocketHandlerInterface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Support\Facades\Log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Swoole\Http\Request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Swoole\WebSocket\Frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Swoole\WebSocket\Server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;WebSocketService&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;WebSocketHandlerInterface&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;__construct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 连接建立时触发&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onOpen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Server&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// 在触发 WebSocket 连接建立事件之前，Laravel 应用初始化的生命周期已经结束，你可以在这里获取 Laravel 请求和会话数据&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// 调用 push 方法向客户端推送数据，fd 是客户端连接标识字段&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;Log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'WebSocket 连接建立'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Welcome to WebSocket Server built on LaravelS'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 收到消息时触发&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Server&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Frame&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// 调用 push 方法向客户端推送数据&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$frame&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;You say {&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$frame&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;}at &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Y-m-d H:i:s'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// 关闭连接时触发&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onClose&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Server&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$fd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$reactorId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;Log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'WebSocket 连接关闭'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;h2 id=&quot;2-更改配置configlaravelsphp&quot;&gt;2. 更改配置config/laravels.php&lt;/h2&gt;
&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;'websocket'&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;'enable'&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 看清楚，这里是true&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;'handler'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\App\Services\WebSocketService&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;'swoole'&lt;/span&gt;         &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//...&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// dispatch_mode只能设置为2、4、5，https://wiki.swoole.com/wiki/page/277.html&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;'dispatch_mode'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;h2 id=&quot;3-配置-nginx-支持-websocket&quot;&gt;3. 配置 Nginx 支持 WebSocket&lt;/h2&gt;
&lt;div class=&quot;language-nginx highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; &lt;span class=&quot;k&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$http_upgrade&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$connection_upgrade&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;kn&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;upgrade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;kn&quot;&gt;''&lt;/span&gt;      &lt;span class=&quot;s&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
 &lt;span class=&quot;k&quot;&gt;upstream&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;swoole&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;c1&quot;&gt;# 通过 IP:Port 连接
&lt;/span&gt;     &lt;span class=&quot;kn&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;127.0.0.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5200&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;weight=5&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;max_fails=3&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;fail_timeout=30s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;c1&quot;&gt;# 通过 UnixSocket Stream 连接，小诀窍：将socket文件放在/dev/shm目录下，可获得更好的性能
&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;#server unix:/xxxpath/laravel-s-test/storage/laravels.sock weight=5 max_fails=3 fail_timeout=30s;
&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;#server 192.168.1.1:5200 weight=3 max_fails=3 fail_timeout=30s;
&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;#server 192.168.1.2:5200 backup;
&lt;/span&gt;     &lt;span class=&quot;kn&quot;&gt;keepalive&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
 &lt;span class=&quot;k&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;kn&quot;&gt;listen&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;c1&quot;&gt;# 别忘了绑Host哟
&lt;/span&gt;     &lt;span class=&quot;kn&quot;&gt;server_name&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;laravels.com&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;kn&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/xxxpath/laravel-s-test/public&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;kn&quot;&gt;access_log&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/yyypath/log/nginx/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$server_name&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;.access.log&lt;/span&gt;  &lt;span class=&quot;s&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;kn&quot;&gt;autoindex&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;off&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;kn&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;index.html&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;index.htm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;c1&quot;&gt;# Nginx处理静态资源(建议开启gzip)，LaravelS处理动态资源。
&lt;/span&gt;     &lt;span class=&quot;kn&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;try_files&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$uri&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;@laravels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
     &lt;span class=&quot;c1&quot;&gt;# 当请求PHP文件时直接响应404，防止暴露public/*.php
&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;#location ~* \.php$ {
&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;#    return 404;
&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;#}
&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;# Http和WebSocket共存，Nginx通过location区分
&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;# !!! WebSocket连接时路径为/ws
&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;# Javascript: var ws = new WebSocket(&quot;ws://laravels.com/ws&quot;);
&lt;/span&gt;     &lt;span class=&quot;kn&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;/ws&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
         &lt;span class=&quot;c1&quot;&gt;# proxy_connect_timeout 60s;
&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;# proxy_send_timeout 60s;
&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;# proxy_read_timeout：如果60秒内被代理的服务器没有响应数据给Nginx，那么Nginx会关闭当前连接；同时，Swoole的心跳设置也会影响连接的关闭
&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;# proxy_read_timeout 60s;
&lt;/span&gt;         &lt;span class=&quot;kn&quot;&gt;proxy_http_version&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Real-IP&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$remote_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Real-PORT&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$remote_port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Forwarded-For&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Host&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$http_host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Scheme&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$scheme&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Server-Protocol&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server_protocol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Server-Name&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Server-Addr&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Server-Port&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server_port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Upgrade&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$http_upgrade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Connection&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$connection_upgrade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_pass&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;http://swoole&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
     &lt;span class=&quot;kn&quot;&gt;location&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;@laravels&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
         &lt;span class=&quot;c1&quot;&gt;# proxy_connect_timeout 60s;
&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;# proxy_send_timeout 60s;
&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;# proxy_read_timeout 60s;
&lt;/span&gt;         &lt;span class=&quot;kn&quot;&gt;proxy_http_version&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Connection&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Real-IP&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$remote_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Real-PORT&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$remote_port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;X-Forwarded-For&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Host&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$http_host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Scheme&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$scheme&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Server-Protocol&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server_protocol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Server-Name&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Server-Addr&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_set_header&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Server-Port&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$server_port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;kn&quot;&gt;proxy_pass&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;http://swoole&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
 &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;4重载配置并重启laravels服务&quot;&gt;4.重载配置并重启Laravels服务&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; php bin/laravels reload
 php bin/laravels restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;这里切记一定要重启 否则websocket无法连接上&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;5配置wss服务&quot;&gt;5.配置wss服务&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;这里只需要把你自己配置的域名升级为https即可 亲测有效&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/websocket_test.png&quot; alt=&quot;第三方测试如下&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;6配置测试页面&quot;&gt;6.配置测试页面&lt;/h2&gt;

&lt;h3 id=&quot;6-1-在webphp新增路由&quot;&gt;6-1 在web.php新增路由&lt;/h3&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;Route&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'/ws'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'ws'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;6-2-在resourcesviews新增wsbladephp&quot;&gt;6-2 在resources/views新增ws.blade.php&lt;/h3&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;head&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;meta&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;charset=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;title&amp;gt;&lt;/span&gt;Chat Client&lt;span class=&quot;nt&quot;&gt;&amp;lt;/title&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;window&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;onload&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;nick&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;prompt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Enter your nickname&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;document&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;getElementById&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;input&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;focus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// 初始化客户端套接字并建立连接&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;WebSocket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;wss://你的域名/ws&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// 连接建立时触发&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;onopen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Connection open ...&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// 接收到服务端推送时执行&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;onmessage&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;msg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;node&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;document&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;createTextNode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;div&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;document&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;createElement&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;div&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;nx&quot;&gt;div&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;appendChild&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;document&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;insertBefore&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;div&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;nx&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;scrollIntoView&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

        &lt;span class=&quot;c1&quot;&gt;// 连接关闭时触发&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;onclose&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Connection closed ...&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;nx&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;onchange&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;msg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;nick&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;: &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// 将输入框变更信息通过 send 方法发送到服务器&lt;/span&gt;
            &lt;span class=&quot;nx&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;nx&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;input&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;id=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;input&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;style=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;width: 100%;&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;6-3-在页面测试如下&quot;&gt;6-3 在页面测试如下&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;测试页面效果&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/websocket_test2.png&quot; alt=&quot;页面测试如下&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;握手过程&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/websocket.jpg&quot; alt=&quot;握手过程&quot; /&gt;&lt;/p&gt;

</description>
        <pubDate>Tue, 10 Dec 2019 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/swoole/%E5%9C%A8-Laravel-%E4%B8%AD%E9%9B%86%E6%88%90-Swoole-%E5%AE%9E%E7%8E%B0-WebSocket-%E6%9C%8D%E5%8A%A1%E5%99%A8/</link>
        <guid isPermaLink="true">http://localhost:4000/swoole/%E5%9C%A8-Laravel-%E4%B8%AD%E9%9B%86%E6%88%90-Swoole-%E5%AE%9E%E7%8E%B0-WebSocket-%E6%9C%8D%E5%8A%A1%E5%99%A8/</guid>
        
        <category>swoole</category>
        
        <category>laravel</category>
        
        <category>websocket</category>
        
        
        <category>swoole</category>
        
      </item>
    
      <item>
        <title>基于swoole实现HTTP高性能服务器</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#1拉取一个新的laravel框架&quot; id=&quot;markdown-toc-1拉取一个新的laravel框架&quot;&gt;1.拉取一个新的laravel框架&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#2-安装配置-laravels&quot; id=&quot;markdown-toc-2-安装配置-laravels&quot;&gt;2. 安装配置 LaravelS&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#3-发布配置&quot; id=&quot;markdown-toc-3-发布配置&quot;&gt;3. 发布配置&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#4启动-laravels&quot; id=&quot;markdown-toc-4启动-laravels&quot;&gt;4.启动 LaravelS&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#5通过-supervisor-管理-laravels&quot; id=&quot;markdown-toc-5通过-supervisor-管理-laravels&quot;&gt;5.通过 Supervisor 管理 LaravelS&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#5-1-安装supervisor&quot; id=&quot;markdown-toc-5-1-安装supervisor&quot;&gt;5-1 安装Supervisor&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#5-2--配置-nginx&quot; id=&quot;markdown-toc-5-2--配置-nginx&quot;&gt;5-2  配置 Nginx&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#5-3配置-laravel-应用&quot; id=&quot;markdown-toc-5-3配置-laravel-应用&quot;&gt;5-3.配置 Laravel 应用&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#5-4-测试一下&quot; id=&quot;markdown-toc-5-4-测试一下&quot;&gt;5-4 测试一下&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;&lt;em&gt;基于swoole实现HTTP高性能服务器&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;1拉取一个新的laravel框架&quot;&gt;1.拉取一个新的laravel框架&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;laravel new laravelSwoole
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;h2 id=&quot;2-安装配置-laravels&quot;&gt;2. 安装配置 LaravelS&lt;/h2&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;composer require hhxsv5/laravel-s
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;h2 id=&quot;3-发布配置&quot;&gt;3. 发布配置&lt;/h2&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; php artisan laravels publish
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;该命令会发布配置文件 laravels.php 到 config 目录下，以及脚本文件到 bin 目录下：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;4启动-laravels&quot;&gt;4.启动 LaravelS&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; php bin/laravels start
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;启动Swoole服务，并且监听本地的5200端口，如果有请求发送到这个端口，它就可以进行处理&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/laravels_start.png&quot; alt=&quot;界面如下&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;此外 php bin/laravels 还支持其它命令对 LaravelS 进行管理：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/static/img/laravels_help.png&quot; alt=&quot;命令如下&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;5通过-supervisor-管理-laravels&quot;&gt;5.通过 Supervisor 管理 LaravelS&lt;/h2&gt;
&lt;h3 id=&quot;5-1-安装supervisor&quot;&gt;5-1 安装Supervisor&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;这里我是用的ubuntu系统。centos系统的话请看我这篇文章&lt;a href=&quot;https://renzhifan.github.io/tool/Centos-7-%E9%85%8D%E7%BD%AE-supervisor-%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/&quot;&gt;Centos-7-配置-supervisor&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; sudo apt-get install supervisor
 cd /etc/supervisor/conf.d
 touch laravel-s-swoole.conf 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;laravel-s-swoole.conf 内容如下&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[program:laravel-s-swoole]
command=php /var/www/laravelSwoole/bin/laravels restart -i
numprocs=1
autostart=true
autorestart=true
startretries=3
user=www-data
redirect_stderr=true
stdout_logfile=/var/www/laravelSwoole/storage/logs/supervisord-stdout.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;Supervisor 重载配置:&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;supervisorctl reload
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;5-2--配置-nginx&quot;&gt;5-2  配置 Nginx&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;我们知道在使用 Nginx 作为 Web 服务器的时候，前端资源文件，比如 CSS、JS、图片等静态资源都是通过 Nginx 进行处理的，比较高效，而 PHP 脚本请求这种动态资源都是转发到后端 PHP-FPM 进程进行处理，如果要基于 Swoole 实现高性能 HTTP 服务器，则这个 HTTP 服务器替代的也是 PHP-FPM 的职能，也就是说，我们将原本转发到 PHP-FPM 进程的请求转发给 Swoole 进行处理。在本例中，就是转发给 LaravelS 服务&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;upstream laravels {
    # Connect IP:Port
    server 127.0.0.1:5200 weight=5 max_fails=3 fail_timeout=30s;
    keepalive 16;
}
server {
    listen 80;
    
    server_name 你的域名;
    root /var/www/laravelSwoole/public;
    index index.php index.html index.htm;
    
    # Nginx 处理静态资源，LaravelS 处理动态资源
    location / {
        try_files $uri @laravels;
    }
    
    location @laravels {
        proxy_http_version 1.1;
        proxy_set_header Connection &quot;&quot;;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Real-PORT $remote_port;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_set_header Scheme $scheme;
        proxy_set_header Server-Protocol $server_protocol;
        proxy_set_header Server-Name $server_name;
        proxy_set_header Server-Addr $server_addr;
        proxy_set_header Server-Port $server_port;
        proxy_pass http://laravels;
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;5-3配置-laravel-应用&quot;&gt;5-3.配置 Laravel 应用&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;在你的env配置文件增加两行&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;LARAVELS_LISTEN_IP=127.0.0.1
LARAVELS_DAEMONIZE=true
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;5-4-测试一下&quot;&gt;5-4 测试一下&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;访问你自己配置的域名能正常出现laravel的首页表示配置成功&lt;/p&gt;
&lt;/blockquote&gt;

</description>
        <pubDate>Mon, 09 Dec 2019 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/swoole/%E5%9F%BA%E4%BA%8Eswoole%E5%AE%9E%E7%8E%B0%E9%AB%98%E6%80%A7%E8%83%BDHTTP%E6%9C%8D%E5%8A%A1%E5%99%A8/</link>
        <guid isPermaLink="true">http://localhost:4000/swoole/%E5%9F%BA%E4%BA%8Eswoole%E5%AE%9E%E7%8E%B0%E9%AB%98%E6%80%A7%E8%83%BDHTTP%E6%9C%8D%E5%8A%A1%E5%99%A8/</guid>
        
        <category>swoole</category>
        
        <category>HTTP</category>
        
        <category>supervisor</category>
        
        
        <category>swoole</category>
        
      </item>
    
      <item>
        <title>让Laravel开发Api更得心应手</title>
        <description>&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#前言&quot; id=&quot;markdown-toc-前言&quot;&gt;前言&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#1安装laravel&quot; id=&quot;markdown-toc-1安装laravel&quot;&gt;1.安装Laravel&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#2建立数据库&quot; id=&quot;markdown-toc-2建立数据库&quot;&gt;2.建立数据库&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#3移动user模型&quot; id=&quot;markdown-toc-3移动user模型&quot;&gt;3.移动User模型&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#3-1-在app目录下新建models文件夹然后将userphp文件移动进来&quot; id=&quot;markdown-toc-3-1-在app目录下新建models文件夹然后将userphp文件移动进来&quot;&gt;3-1. 在app目录下新建Models文件夹，然后将User.php文件移动进来。&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#3-2--修改userphp的内容&quot; id=&quot;markdown-toc-3-2--修改userphp的内容&quot;&gt;3-2.  修改User.php的内容&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#3-3--因为有关于user的命名空间发生了改变所以我们全局搜索appuser将其替换为appmodelsuser我一共搜索到3个文件&quot; id=&quot;markdown-toc-3-3--因为有关于user的命名空间发生了改变所以我们全局搜索appuser将其替换为appmodelsuser我一共搜索到3个文件&quot;&gt;3-3.  因为有关于User的命名空间发生了改变，所以我们全局搜索App\User,将其替换为App\Models\User我一共搜索到3个文件&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#4创建对应的控制器路由以及对应的验证器可参考源码&quot; id=&quot;markdown-toc-4创建对应的控制器路由以及对应的验证器可参考源码&quot;&gt;4.创建对应的控制器路由以及对应的验证器（可参考源码）&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#5生成一批测试数据-可参考我seed里面对应的文件&quot; id=&quot;markdown-toc-5生成一批测试数据-可参考我seed里面对应的文件&quot;&gt;5.生成一批测试数据 可参考我seed里面对应的文件&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#6跨域问题&quot; id=&quot;markdown-toc-6跨域问题&quot;&gt;6.跨域问题&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#6-1安装medzcors&quot; id=&quot;markdown-toc-6-1安装medzcors&quot;&gt;6-1.安装medz/cors&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#6-2发布配置文件&quot; id=&quot;markdown-toc-6-2发布配置文件&quot;&gt;6-2.发布配置文件&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#6-3-修改配置文件&quot; id=&quot;markdown-toc-6-3-修改配置文件&quot;&gt;6-3. 修改配置文件&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#6-4增加中间件别名&quot; id=&quot;markdown-toc-6-4增加中间件别名&quot;&gt;6-4.增加中间件别名&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#6-5-修改路由增加刚才的中间件&quot; id=&quot;markdown-toc-6-5-修改路由增加刚才的中间件&quot;&gt;6-5. 修改路由(增加刚才的中间件)&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#7统一response响应处理参考这里&quot; id=&quot;markdown-toc-7统一response响应处理参考这里&quot;&gt;7.统一Response响应处理参考这里&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#8创建自定义异常处理&quot; id=&quot;markdown-toc-8创建自定义异常处理&quot;&gt;8.创建自定义异常处理&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#9捕捉异常&quot; id=&quot;markdown-toc-9捕捉异常&quot;&gt;9.捕捉异常&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#10jwt-auth&quot; id=&quot;markdown-toc-10jwt-auth&quot;&gt;10.jwt-auth&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#10-1-安装&quot; id=&quot;markdown-toc-10-1-安装&quot;&gt;10-1. 安装&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#10-2配置&quot; id=&quot;markdown-toc-10-2配置&quot;&gt;10-2.配置&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#10-3-添加服务提供商-打开-config-目录下的-appphp文件添加下面代码&quot; id=&quot;markdown-toc-10-3-添加服务提供商-打开-config-目录下的-appphp文件添加下面代码&quot;&gt;10-3. 添加服务提供商 打开 config 目录下的 app.php文件，添加下面代码&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#10-4-发布配置文件&quot; id=&quot;markdown-toc-10-4-发布配置文件&quot;&gt;10-4. 发布配置文件&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#10-5-生成密钥&quot; id=&quot;markdown-toc-10-5-生成密钥&quot;&gt;10-5. 生成密钥&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#10-6-配置-auth-guard&quot; id=&quot;markdown-toc-10-6-配置-auth-guard&quot;&gt;10-6. 配置 Auth guard&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#10-7-更改-model&quot; id=&quot;markdown-toc-10-7-更改-model&quot;&gt;10-7. 更改 Model&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#10-8-配置项详解&quot; id=&quot;markdown-toc-10-8-配置项详解&quot;&gt;10-8. 配置项详解&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#11-自动刷新用户认证&quot; id=&quot;markdown-toc-11-自动刷新用户认证&quot;&gt;11. 自动刷新用户认证&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#11-1自定义认证中间件&quot; id=&quot;markdown-toc-11-1自定义认证中间件&quot;&gt;11-1.自定义认证中间件&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#11-2-打开-apphttpmiddlewareapi-目录下的-refreshtokenmiddlewarephp-文件填写以下内容&quot; id=&quot;markdown-toc-11-2-打开-apphttpmiddlewareapi-目录下的-refreshtokenmiddlewarephp-文件填写以下内容&quot;&gt;11-2. 打开 app/Http/Middleware/Api 目录下的 RefreshTokenMiddleware.php 文件，填写以下内容&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#11-3增加中间件别名&quot; id=&quot;markdown-toc-11-3增加中间件别名&quot;&gt;11-3.增加中间件别名&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#11-4单一设备登陆&quot; id=&quot;markdown-toc-11-4单一设备登陆&quot;&gt;11-4.单一设备登陆&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#11-5修改-apphttpcontrollersapiadmincontrollerphp-中的-login方法在登陆的时候拉黑上一个token&quot; id=&quot;markdown-toc-11-5修改-apphttpcontrollersapiadmincontrollerphp-中的-login方法在登陆的时候拉黑上一个token&quot;&gt;11-5.修改 app\Http\Controllers\Api\AdminController.php 中的 login方法，在登陆的时候，拉黑上一个token。&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#11-6-再修改中间件apphttpmiddlewareapirefreshadmintokenmiddlewarephp-更新的token加到last_token&quot; id=&quot;markdown-toc-11-6-再修改中间件apphttpmiddlewareapirefreshadmintokenmiddlewarephp-更新的token加到last_token&quot;&gt;11-6. 再修改中间件app/Http/Middleware/Api/RefreshAdminTokenMiddleware.php ，更新的token加到last_token&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#12horizon管理异步队列&quot; id=&quot;markdown-toc-12horizon管理异步队列&quot;&gt;12.horizon管理异步队列&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#12-1修改队列驱动&quot; id=&quot;markdown-toc-12-1修改队列驱动&quot;&gt;12-1.修改队列驱动&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#12-2编写任务类&quot; id=&quot;markdown-toc-12-2编写任务类&quot;&gt;12-2.编写任务类&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#12-3打开-appjobsapisavelasttokenjobphp-文件-填写以下内容&quot; id=&quot;markdown-toc-12-3打开-appjobsapisavelasttokenjobphp-文件-填写以下内容&quot;&gt;12-3.打开 app/Jobs/Api/SaveLastTokenJob.php 文件 ，填写以下内容&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#12-4-使用任务类&quot; id=&quot;markdown-toc-12-4-使用任务类&quot;&gt;12-4. 使用任务类&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#12-5-运行horizon&quot; id=&quot;markdown-toc-12-5-运行horizon&quot;&gt;12-5. 运行Horizon&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#13supervisor守护进程-可参考我的文章centos-7-配置-supervisor-遇到的坑&quot; id=&quot;markdown-toc-13supervisor守护进程-可参考我的文章centos-7-配置-supervisor-遇到的坑&quot;&gt;13.Supervisor守护进程 （可参考我的文章）Centos-7-配置-supervisor-遇到的坑&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;前言&quot;&gt;前言&lt;/h3&gt;
&lt;p&gt;先把源码扔出来 可进行对比参考 &lt;a href=&quot;https://github.com/renzhifan/laravelApi&quot;&gt;手摸手教你让Laravel开发Api更得心应手&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;
&lt;h2 id=&quot;1安装laravel&quot;&gt;1.安装Laravel&lt;/h2&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
laravel new laravelApi (这里我使用的laravel安装器 默认安装最新版本)
如果要安装指定版本的话建议使用composer
composer create-project laravel/laravel Laravel --prefer-dist &quot;6.0.*&quot;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;2建立数据库&quot;&gt;2.建立数据库&lt;/h2&gt;
&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;php&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;artisan&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;migration&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;create_users_table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;里面内容可参考我对应的文件&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;3移动user模型&quot;&gt;3.移动User模型&lt;/h2&gt;

&lt;h3 id=&quot;3-1-在app目录下新建models文件夹然后将userphp文件移动进来&quot;&gt;3-1. 在app目录下新建Models文件夹，然后将User.php文件移动进来。&lt;/h3&gt;

&lt;h3 id=&quot;3-2--修改userphp的内容&quot;&gt;3-2.  修改User.php的内容&lt;/h3&gt;
&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;App\Models&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//这里从App改成了App\Models&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Notifications\Notifiable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Foundation\Auth\User&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Authenticatable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;User&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Authenticatable&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Notifiable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$table&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'users'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

     &lt;span class=&quot;c1&quot;&gt;//去掉我创建的数据表没有的字段&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$fillable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'name'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'password'&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

     &lt;span class=&quot;c1&quot;&gt;//去掉我创建的数据表没有的字段&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$hidden&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'password'&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//将密码进行加密&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setPasswordAttribute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;attributes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'password'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;bcrypt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;3-3--因为有关于user的命名空间发生了改变所以我们全局搜索appuser将其替换为appmodelsuser我一共搜索到3个文件&quot;&gt;3-3.  因为有关于User的命名空间发生了改变，所以我们全局搜索App\User,将其替换为App\Models\User我一共搜索到3个文件&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;app/Http/Controllers/Auth 目录下的 RegisterController.php
config 目录下的 services.php
config 目录下的 auth.php
database/factories 目录下的 UserFactory.php

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;4创建对应的控制器路由以及对应的验证器可参考源码&quot;&gt;4.创建对应的控制器路由以及对应的验证器（可参考源码）&lt;/h2&gt;

&lt;h2 id=&quot;5生成一批测试数据-可参考我seed里面对应的文件&quot;&gt;5.生成一批测试数据 可参考我seed里面对应的文件&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;php artisan db:seed;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;6跨域问题&quot;&gt;6.跨域问题&lt;/h2&gt;
&lt;h3 id=&quot;6-1安装medzcors&quot;&gt;6-1.安装medz/cors&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;composer require medz/cors

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;6-2发布配置文件&quot;&gt;6-2.发布配置文件&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
php artisan vendor:publish --provider=&quot;Medz\Cors\Laravel\Providers\LaravelServiceProvider&quot; --force

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;6-3-修改配置文件&quot;&gt;6-3. 修改配置文件&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;return [
    ......
    'expose-headers'     =&amp;gt; ['Authorization'],
    ......
];

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;这样跨域请求时，才能返回header头为Authorization的内容，否则在刷新用户token时不会返回刷新后的token&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;6-4增加中间件别名&quot;&gt;6-4.增加中间件别名&lt;/h3&gt;

&lt;p&gt;打开App\Http下的Kernel文件&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$routeMiddleware&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'auth'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\App\Http\Middleware\Authenticate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'auth.basic'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Illuminate\Auth\Middleware\AuthenticateWithBasicAuth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'bindings'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Illuminate\Routing\Middleware\SubstituteBindings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'cache.headers'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Illuminate\Http\Middleware\SetCacheHeaders&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'can'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Illuminate\Auth\Middleware\Authorize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'guest'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\App\Http\Middleware\RedirectIfAuthenticated&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'password.confirm'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Illuminate\Auth\Middleware\RequirePassword&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'signed'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Illuminate\Routing\Middleware\ValidateSignature&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'throttle'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Illuminate\Routing\Middleware\ThrottleRequests&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'verified'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Illuminate\Auth\Middleware\EnsureEmailIsVerified&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;......&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//前面的中间件&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'cors'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;\Medz\Cors\Laravel\Middleware\ShouldGroup&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;6-5-修改路由增加刚才的中间件&quot;&gt;6-5. 修改路由(增加刚才的中间件)&lt;/h3&gt;

&lt;h2 id=&quot;7统一response响应处理参考这里&quot;&gt;7.统一Response响应处理&lt;a href=&quot;https://learnku.com/articles/6035/laravel55-developing-api-combat&quot;&gt;参考这里&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;也可以把我对应的文件直接复制过去&lt;/p&gt;

&lt;h2 id=&quot;8创建自定义异常处理&quot;&gt;8.创建自定义异常处理&lt;/h2&gt;
&lt;p&gt;在 app/Api/Helpers 目录下新建 ExceptionReport.php 文件（对应内容填写我对应的文件里面的）&lt;/p&gt;

&lt;h2 id=&quot;9捕捉异常&quot;&gt;9.捕捉异常&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;修改 app/Exceptions 目录下的 Handler.php 文件&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;App\Exceptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;App\Api\Helpers\ExceptionReport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Foundation\Exceptions\Handler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ExceptionHandler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Handler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ExceptionHandler&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//ajax请求我们才捕捉异常&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ajax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()){&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// 将方法拦截到自己的ExceptionReport&lt;/span&gt;
            &lt;span class=&quot;nv&quot;&gt;$reporter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ExceptionReport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$reporter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;shouldReturn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()){&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$reporter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;report&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'APP_DEBUG'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
                &lt;span class=&quot;c1&quot;&gt;//开发环境，则显示详细错误信息&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;parent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;c1&quot;&gt;//线上环境,未知错误，则显示500&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$reporter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;prodReport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;parent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;10jwt-auth&quot;&gt;10.jwt-auth&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;在传统web中，我们一般是使用session来判定一个用户的登陆状态。而在API开发中，我们使用的是token。jwt-token是Laravel开发API用的比较多的。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;jwt-auth的详细介绍分析可以看&lt;a href=&quot;https://learnku.com/articles/17883&quot;&gt;JWT超详细分析&lt;/a&gt;这篇文章，具体使用可以看&lt;a href=&quot;https://learnku.com/articles/10885/full-use-of-jwt&quot;&gt;JWT完整使用详解&lt;/a&gt; 这篇文章。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;10-1-安装&quot;&gt;10-1. 安装&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   composer require tymon/jwt-auth 1.0.0-rc.5
   如果是Laravel5.5版本，则安装rc.1。如果是Laravel5.6版本，则安装rc.2。我这里安装的最新rc.5版本
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;10-2配置&quot;&gt;10-2.配置&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;配置参考来自使用 &lt;a href=&quot;https://learnku.com/articles/7264/using-jwt-auth-to-implement-api-user-authentication-and-painless-refresh-access-token&quot;&gt;Jwt-Auth 实现 API 用户认证以及无痛刷新访问令牌&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;10-3-添加服务提供商-打开-config-目录下的-appphp文件添加下面代码&quot;&gt;10-3. 添加服务提供商 打开 config 目录下的 app.php文件，添加下面代码&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   'providers' =&amp;gt; [
   
       ...
   
       Tymon\JWTAuth\Providers\LaravelServiceProvider::class,
   ]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;10-4-发布配置文件&quot;&gt;10-4. 发布配置文件&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   php artisan vendor:publish --provider=&quot;Tymon\JWTAuth\Providers\LaravelServiceProvider&quot;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;此命令会在 config 目录下生成一个 jwt.php 配置文件，你可以在此进行自定义配置。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;10-5-生成密钥&quot;&gt;10-5. 生成密钥&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  php artisan jwt:secret

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;
  &lt;p&gt;此命令会在你的 .env 文件中新增一行 JWT_SECRET=secret。以此来作为加密时使用的秘钥。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;10-6-配置-auth-guard&quot;&gt;10-6. 配置 Auth guard&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;打开 config 目录下的 auth.php文件，修改为下面代码&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; 'guards' =&amp;gt; [
     'web' =&amp;gt; [
         'driver' =&amp;gt; 'session',
         'provider' =&amp;gt; 'users',
     ],
 
     'api' =&amp;gt; [
        'driver' =&amp;gt; 'jwt',
        'provider' =&amp;gt; 'users',
     ],
 ],
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;这样，我们就能让api的用户认证变成使用jwt。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;10-7-更改-model&quot;&gt;10-7. 更改 Model&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; &amp;lt;?php
 
 namespace App\Models;
 
 use Illuminate\Notifications\Notifiable;
 use Illuminate\Foundation\Auth\User as Authenticatable;
 use Tymon\JWTAuth\Contracts\JWTSubject;
 
 class User extends Authenticatable implements JWTSubject
 {
     use Notifiable;
 
     public function getJWTIdentifier()
     {
         return $this-&amp;gt;getKey();
     }
 
     public function getJWTCustomClaims()
     {
         return [];
     }
    ......
 }
 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;10-8-配置项详解&quot;&gt;10-8. 配置项详解&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;config目录下的jwt.php文件配置详解&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
  
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      |--------------------------------------------------------------------------
      | JWT Authentication Secret
      |--------------------------------------------------------------------------
      |
      | 用于加密生成 token 的 secret
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'secret'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'JWT_SECRET'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      |--------------------------------------------------------------------------
      | JWT Authentication Keys
      |--------------------------------------------------------------------------
      |
      | 如果你在 .env 文件中定义了 JWT_SECRET 的随机字符串
      | 那么 jwt 将会使用 对称算法 来生成 token
      | 如果你没有定有，那么jwt 将会使用如下配置的公钥和私钥来生成 token
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'keys'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
  
          &lt;span class=&quot;cm&quot;&gt;/*
          |--------------------------------------------------------------------------
          | Public Key
          |--------------------------------------------------------------------------
          |
          | 公钥
          |
          */&lt;/span&gt;
  
          &lt;span class=&quot;s1&quot;&gt;'public'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'JWT_PUBLIC_KEY'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  
          &lt;span class=&quot;cm&quot;&gt;/*
          |--------------------------------------------------------------------------
          | Private Key
          |--------------------------------------------------------------------------
          |
          | 私钥
          |
          */&lt;/span&gt;
  
          &lt;span class=&quot;s1&quot;&gt;'private'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'JWT_PRIVATE_KEY'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  
          &lt;span class=&quot;cm&quot;&gt;/*
          |--------------------------------------------------------------------------
          | Passphrase
          |--------------------------------------------------------------------------
          |
          | 私钥的密码。 如果没有设置，可以为 null。
          |
          */&lt;/span&gt;
  
          &lt;span class=&quot;s1&quot;&gt;'passphrase'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'JWT_PASSPHRASE'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  
      &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      |--------------------------------------------------------------------------
      | JWT time to live
      |--------------------------------------------------------------------------
      |
      | 指定 access_token 有效的时间长度（以分钟为单位），默认为1小时，您也可以将其设置为空，以产生永不过期的标记
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'ttl'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'JWT_TTL'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      |--------------------------------------------------------------------------
      | Refresh time to live
      |--------------------------------------------------------------------------
      |
      | 指定 access_token 可刷新的时间长度（以分钟为单位）。默认的时间为 2 周。
      | 大概意思就是如果用户有一个 access_token，那么他可以带着他的 access_token 
      | 过来领取新的 access_token，直到 2 周的时间后，他便无法继续刷新了，需要重新登录。
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'refresh_ttl'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'JWT_REFRESH_TTL'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;20160&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      |--------------------------------------------------------------------------
      | JWT hashing algorithm
      |--------------------------------------------------------------------------
      |
      | 指定将用于对令牌进行签名的散列算法。
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'algo'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'JWT_ALGO'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'HS256'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      |--------------------------------------------------------------------------
      | Required Claims
      |--------------------------------------------------------------------------
      |
      | 指定必须存在于任何令牌中的声明。
      | 
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'required_claims'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;s1&quot;&gt;'iss'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;s1&quot;&gt;'iat'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;s1&quot;&gt;'exp'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;s1&quot;&gt;'nbf'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;s1&quot;&gt;'sub'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;s1&quot;&gt;'jti'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      |--------------------------------------------------------------------------
      | Persistent Claims
      |--------------------------------------------------------------------------
      |
      | 指定在刷新令牌时要保留的声明密钥。
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'persistent_claims'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// 'foo',&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// 'bar',&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      |--------------------------------------------------------------------------
      | Blacklist Enabled
      |--------------------------------------------------------------------------
      |
      | 为了使令牌无效，您必须启用黑名单。
      | 如果您不想或不需要此功能，请将其设置为 false。
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'blacklist_enabled'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'JWT_BLACKLIST_ENABLED'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      | -------------------------------------------------------------------------
      | Blacklist Grace Period
      | -------------------------------------------------------------------------
      |
      | 当多个并发请求使用相同的JWT进行时，
      | 由于 access_token 的刷新 ，其中一些可能会失败
      | 以秒为单位设置请求时间以防止并发的请求失败。
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'blacklist_grace_period'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'JWT_BLACKLIST_GRACE_PERIOD'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  
      &lt;span class=&quot;cm&quot;&gt;/*
      |--------------------------------------------------------------------------
      | Providers
      |--------------------------------------------------------------------------
      |
      | 指定整个包中使用的各种提供程序。
      |
      */&lt;/span&gt;
  
      &lt;span class=&quot;s1&quot;&gt;'providers'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
  
          &lt;span class=&quot;cm&quot;&gt;/*
          |--------------------------------------------------------------------------
          | JWT Provider
          |--------------------------------------------------------------------------
          |
          | 指定用于创建和解码令牌的提供程序。
          |
          */&lt;/span&gt;
  
          &lt;span class=&quot;s1&quot;&gt;'jwt'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Tymon\JWTAuth\Providers\JWT\Namshi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  
          &lt;span class=&quot;cm&quot;&gt;/*
          |--------------------------------------------------------------------------
          | Authentication Provider
          |--------------------------------------------------------------------------
          |
          | 指定用于对用户进行身份验证的提供程序。
          |
          */&lt;/span&gt;
  
          &lt;span class=&quot;s1&quot;&gt;'auth'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Tymon\JWTAuth\Providers\Auth\Illuminate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  
          &lt;span class=&quot;cm&quot;&gt;/*
          |--------------------------------------------------------------------------
          | Storage Provider
          |--------------------------------------------------------------------------
          |
          | 指定用于在黑名单中存储标记的提供程序。
          |
          */&lt;/span&gt;
  
          &lt;span class=&quot;s1&quot;&gt;'storage'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Tymon\JWTAuth\Providers\Storage\Illuminate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  
      &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
  
  &lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;11-自动刷新用户认证&quot;&gt;11. 自动刷新用户认证&lt;/h2&gt;
&lt;h3 id=&quot;11-1自定义认证中间件&quot;&gt;11-1.自定义认证中间件&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   
   php artisan make:middleware Api/RefreshTokenMiddleware
   
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;11-2-打开-apphttpmiddlewareapi-目录下的-refreshtokenmiddlewarephp-文件填写以下内容&quot;&gt;11-2. 打开 app/Http/Middleware/Api 目录下的 RefreshTokenMiddleware.php 文件，填写以下内容&lt;/h3&gt;
&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
  
  &lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;App\Http\Middleware\Api&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Auth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Closure&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Tymon\JWTAuth\Exceptions\JWTException&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Tymon\JWTAuth\Facades\JWTAuth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Tymon\JWTAuth\Http\Middleware\BaseMiddleware&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Tymon\JWTAuth\Exceptions\TokenExpiredException&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;c1&quot;&gt;// 注意，我们要继承的是 jwt 的 BaseMiddleware&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RefreshTokenMiddleware&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;BaseMiddleware&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;sd&quot;&gt;/**
       * Handle an incoming request.
       *
       * @param  \Illuminate\Http\Request $request
       * @param  \Closure $next
       *
       * @throws \Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException
       *
       * @return mixed
       */&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Closure&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// 检查此次请求中是否带有 token，如果没有则抛出异常。&lt;/span&gt;
          &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;checkForToken&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;//         使用 try 包裹，以捕捉 token 过期所抛出的 TokenExpiredException  异常&lt;/span&gt;
          &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;c1&quot;&gt;// 检测用户的登录状态，如果正常则通过&lt;/span&gt;
              &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;parseToken&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;authenticate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
              &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
              &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;UnauthorizedHttpException&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'jwt-auth'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'未登录'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;TokenExpiredException&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
              &lt;span class=&quot;c1&quot;&gt;// 此处捕获到了 token 过期所抛出的 TokenExpiredException 异常，我们在这里需要做的是刷新该用户的 token 并将它添加到响应头中&lt;/span&gt;
              &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                  &lt;span class=&quot;c1&quot;&gt;// 刷新用户的 token&lt;/span&gt;
                  &lt;span class=&quot;nv&quot;&gt;$token&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;refresh&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
                  &lt;span class=&quot;c1&quot;&gt;// 使用一次性登录以保证此次请求的成功&lt;/span&gt;
                  &lt;span class=&quot;nx&quot;&gt;Auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;guard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'api'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;onceUsingId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;manager&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getPayloadFactory&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;buildClaimsCollection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;toPlainArray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'sub'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
              &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;JWTException&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                  &lt;span class=&quot;c1&quot;&gt;// 如果捕获到此异常，即代表 refresh 也过期了，用户无法刷新令牌，需要重新登录。&lt;/span&gt;
                  &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;UnauthorizedHttpException&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'jwt-auth'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$exception&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
              &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  
          &lt;span class=&quot;c1&quot;&gt;// 在响应头中返回新的 token&lt;/span&gt;
          &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setAuthenticationHeader&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;11-3增加中间件别名&quot;&gt;11-3.增加中间件别名&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  protected $routeMiddleware = [
      ......
      'api.refresh'=&amp;gt;\App\Http\Middleware\Api\RefreshTokenMiddleware::class,
  ];
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;11-4单一设备登陆&quot;&gt;11-4.单一设备登陆&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;同一时间只允许登录唯一一台设备。例如设备 A 中用户如果已经登录，那么使用设备 B 登录同一账户，设备 A 就无法继续使用了。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;我们在登陆，token过期自动更换的时候，都会产生一个新的token。
 我们将token都存到表中的last_token字段。在登陆接口，获取到last_token里的值，将其加入黑名单。
 这样，只要我们无论在哪里登陆，之前的token一定会被拉黑失效，必须重新登陆，我们的目的也就达到了。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;11-5修改-apphttpcontrollersapiadmincontrollerphp-中的-login方法在登陆的时候拉黑上一个token&quot;&gt;11-5.修改 app\Http\Controllers\Api\AdminController.php 中的 login方法，在登陆的时候，拉黑上一个token。&lt;/h3&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    &lt;span class=&quot;c1&quot;&gt;//用户登录&lt;/span&gt;
       &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;login&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
           &lt;span class=&quot;nv&quot;&gt;$token&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;guard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'api'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;attempt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'name'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'password'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
               &lt;span class=&quot;c1&quot;&gt;//如果登陆，先检查原先是否有存token，有的话先失效，然后再存入最新的token&lt;/span&gt;
               &lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;guard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'api'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
               &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'last_token'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                   &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                       &lt;span class=&quot;nx&quot;&gt;Auth&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;guard&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'api'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setToken&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'last_token'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;invalidate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
                   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;TokenExpiredException&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
                       &lt;span class=&quot;c1&quot;&gt;//因为让一个过期的token再失效，会抛出异常，所以我们捕捉异常，不需要做任何处理&lt;/span&gt;
                   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
               &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
               &lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;last_token&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
               &lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;  
               &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setStatusCode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;201&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;success&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'token'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'bearer '&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
           &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;failed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'账号或密码错误'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;400&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
       &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
       
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;11-6-再修改中间件apphttpmiddlewareapirefreshadmintokenmiddlewarephp-更新的token加到last_token&quot;&gt;11-6. 再修改中间件app/Http/Middleware/Api/RefreshAdminTokenMiddleware.php ，更新的token加到last_token&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   ......
   
   try {
               // 检测用户的登录状态，如果正常则通过
               if ($this-&amp;gt;auth-&amp;gt;parseToken()-&amp;gt;authenticate()) {
                   return $next($request);
               }
               throw new UnauthorizedHttpException('jwt-auth', '未登录');
           } catch (TokenExpiredException $exception) {
               // 3. 此处捕获到了 token 过期所抛出的 TokenExpiredException 异常，我们在这里需要做的是刷新该用户的 token 并将它添加到响应头中
               try {
                   // 刷新用户的 token
                   $token = $this-&amp;gt;auth-&amp;gt;refresh();
                   // 使用一次性登录以保证此次请求的成功
                   Auth::onceUsingId($this-&amp;gt;auth-&amp;gt;manager()-&amp;gt;getPayloadFactory()-&amp;gt;buildClaimsCollection()-&amp;gt;toPlainArray()['sub']);
                   //刷新了token，将token存入数据库
                   $user = Auth::user();
                   $user-&amp;gt;last_token = $token;
                   $user-&amp;gt;save();
               } catch (JWTException $exception) {
                   // 如果捕获到此异常，即代表 refresh 也过期了，用户无法刷新令牌，需要重新登录。
                   throw new UnauthorizedHttpException('jwt-auth', $exception-&amp;gt;getMessage());
               }
           }
           
     ......
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;12horizon管理异步队列&quot;&gt;12.horizon管理异步队列&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
composer require laravel/horizon


php artisan vendor:publish --provider=&quot;Laravel\Horizon\HorizonServiceProvider&quot;

composer require predis/predis
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;12-1修改队列驱动&quot;&gt;12-1.修改队列驱动&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;在.env配置里面 修改 
QUEUE_CONNECTION=redis
并加上REDIS_CLIENT=predis&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;12-2编写任务类&quot;&gt;12-2.编写任务类&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  php artisan make:job Api/SaveLastTokenJob

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;12-3打开-appjobsapisavelasttokenjobphp-文件-填写以下内容&quot;&gt;12-3.打开 app/Jobs/Api/SaveLastTokenJob.php 文件 ，填写以下内容&lt;/h3&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
  
  &lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;App\Jobs\Api&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Bus\Queueable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Queue\SerializesModels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Queue\InteractsWithQueue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Contracts\Queue\ShouldQueue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Illuminate\Foundation\Bus\Dispatchable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;SaveLastTokenJob&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ShouldQueue&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Dispatchable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;InteractsWithQueue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Queueable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;SerializesModels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  
      &lt;span class=&quot;sd&quot;&gt;/**
       * SaveLastTokenJob constructor.
       * @param $model
       * @param $token
       */&lt;/span&gt;
  
      &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;__construct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;//&lt;/span&gt;
          &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;model&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  
      &lt;span class=&quot;sd&quot;&gt;/**
       * Execute the job.
       *
       * @return void
       */&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;handle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;last_token&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;nv&quot;&gt;$user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;12-4-使用任务类&quot;&gt;12-4. 使用任务类&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   SaveLastTokenJob::dispatch($user,$token);

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;12-5-运行horizon&quot;&gt;12-5. 运行Horizon&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;   php artisan horizon
   
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;13supervisor守护进程-可参考我的文章centos-7-配置-supervisor-遇到的坑&quot;&gt;13.Supervisor守护进程 （可参考我的文章）&lt;a href=&quot;https://renzhifan.github.io/tool/Centos-7-%E9%85%8D%E7%BD%AE-supervisor-%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/&quot;&gt;Centos-7-配置-supervisor-遇到的坑&lt;/a&gt;&lt;/h2&gt;
</description>
        <pubDate>Fri, 06 Dec 2019 00:00:00 +0800</pubDate>
        <link>http://localhost:4000/laravel/%E8%AE%A9Laravel%E5%BC%80%E5%8F%91Api%E6%9B%B4%E5%BE%97%E5%BF%83%E5%BA%94%E6%89%8B/</link>
        <guid isPermaLink="true">http://localhost:4000/laravel/%E8%AE%A9Laravel%E5%BC%80%E5%8F%91Api%E6%9B%B4%E5%BE%97%E5%BF%83%E5%BA%94%E6%89%8B/</guid>
        
        <category>api</category>
        
        <category>jwt</category>
        
        <category>horizon</category>
        
        
        <category>laravel</category>
        
      </item>
    
  </channel>
</rss>
